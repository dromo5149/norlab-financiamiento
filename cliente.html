<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mi Portal â€” NORLAB</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script>
// Cargar Conekta de forma no bloqueante
(function(){
  var s = document.createElement('script');
  s.src = 'https://cdn.conekta.io/assets/lib/conekta-2.0.0.min.js';
  s.onerror = function(){ window.Conekta = null; console.warn('Conekta no cargÃ³'); };
  s.onload = function(){
    if(window.Conekta && window.Conekta.setPublicKey){
      window.Conekta.setPublicKey('key_R3Pviq4lH1Z4AIJYEv8ZHxr');
    }
  };
  document.head.appendChild(s);
})();
</script>
<style>
:root {
  --navy:   #1A3A4A;
  --blue:   #2A5870;
  --mid:    #2D7EA8;
  --teal:   #4AB8C8;
  --light:  #D6EAF5;
  --bg:     #F0F5F9;
  --card:   #FFFFFF;
  --border: #C8D8E5;
  --muted:  #7A95A8;
  --text:   #1A3A4A;
  --green:  #0d7c66;
  --green-bg: #e6f7f4;
  --yellow: #b45309;
  --yellow-bg: #fef9ee;
  --red:    #c0392b;
  --red-bg: #fff0ee;
  --font: 'DM Sans', sans-serif;
  --mono: 'DM Mono', monospace;
  --radius: 14px;
  --shadow: 0 2px 16px rgba(26,58,74,.08);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: var(--font); background: var(--bg); color: var(--text);
       min-height: 100vh; -webkit-font-smoothing: antialiased; }

/* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-screen {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: linear-gradient(135deg, #0F2430 0%, #1A3A4A 50%, #2A5870 100%);
  padding: 24px;
}
.login-card {
  background: #fff; border-radius: 20px; padding: 44px 40px;
  width: 100%; max-width: 420px; box-shadow: 0 24px 80px rgba(0,0,0,.25);
}
.login-logo { display: flex; align-items: center; gap: 12px; margin-bottom: 32px; justify-content: center; }
.login-logo img { height: 42px; }
.login-title { font-size: 22px; font-weight: 700; color: var(--navy); margin-bottom: 6px; }
.login-sub { font-size: 14px; color: var(--muted); margin-bottom: 28px; }
.field { margin-bottom: 18px; }
.field label { display: block; font-size: 12px; font-weight: 600; color: var(--blue);
               text-transform: uppercase; letter-spacing: .6px; margin-bottom: 7px; }
.field input {
  width: 100%; padding: 13px 16px; border: 1.5px solid var(--border);
  border-radius: 10px; font-family: var(--font); font-size: 15px; color: var(--text);
  outline: none; transition: border-color .2s;
}
.field input:focus { border-color: var(--mid); }
.btn-primary {
  width: 100%; padding: 14px; background: var(--blue); color: #fff;
  border: none; border-radius: 10px; font-family: var(--font); font-size: 15px;
  font-weight: 600; cursor: pointer; transition: background .2s, transform .1s;
}
.btn-primary:hover { background: var(--navy); }
.btn-primary:active { transform: scale(.98); }
.btn-primary:disabled { background: var(--border); color: var(--muted); cursor: default; }
.login-error { background: var(--red-bg); color: var(--red); border-radius: 8px;
               padding: 10px 14px; font-size: 13px; margin-top: 14px; display: none; }

/* â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#dashboard { display: none; min-height: 100vh; }

/* Header */
.dash-header {
  background: var(--navy); color: #fff; padding: 0 32px;
  height: 62px; display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
}
.dash-header-logo { display: flex; align-items: center; gap: 10px; }
.dash-header-logo img { height: 30px; }
.dash-header-right { display: flex; align-items: center; gap: 16px; }
.folio-badge {
  font-family: var(--mono); font-size: 13px; font-weight: 500;
  background: rgba(255,255,255,.12); padding: 5px 12px; border-radius: 20px;
}
.btn-logout {
  font-size: 13px; color: rgba(255,255,255,.6); background: none; border: none;
  cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: background .2s;
  font-family: var(--font); font-weight: 500;
}
.btn-logout:hover { background: rgba(255,255,255,.08); color: #fff; }

/* Main */
.dash-main {
  max-width: 1080px; margin: 0 auto; padding: 32px 24px 80px;
}
.dash-welcome {
  font-size: 26px; font-weight: 700; color: var(--navy); margin-bottom: 8px;
}
.dash-sub {
  font-size: 15px; color: var(--muted); margin-bottom: 32px;
}

/* Cards */
.card {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 24px; box-shadow: var(--shadow); margin-bottom: 20px;
}
.card-title {
  font-size: 16px; font-weight: 700; color: var(--navy); margin-bottom: 16px;
}
.card-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px;
}
.stat-box {
  text-align: center; padding: 20px; background: var(--bg); border-radius: 12px;
}
.stat-value {
  font-size: 32px; font-weight: 800; color: var(--navy); line-height: 1;
  margin-bottom: 6px;
}
.stat-label {
  font-size: 12px; text-transform: uppercase; letter-spacing: .8px;
  color: var(--muted); font-weight: 600;
}
.stat-box.green .stat-value { color: var(--green); }
.stat-box.yellow .stat-value { color: var(--yellow); }
.stat-box.red .stat-value { color: var(--red); }

/* Botones de acciÃ³n */
.btn-pago {
  width: 100%; padding: 14px 20px; background: var(--mid); color: #fff;
  border: none; border-radius: 10px; font-family: var(--font); font-size: 15px;
  font-weight: 600; cursor: pointer; display: flex; align-items: center;
  justify-content: center; gap: 10px; transition: background .2s, transform .1s;
}
.btn-pago:hover { background: var(--blue); }
.btn-pago:active { transform: scale(.98); }
.btn-descargar {
  display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px;
  background: var(--light); color: var(--blue); border: 1px solid var(--border);
  border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;
  transition: background .2s; text-decoration: none;
}
.btn-descargar:hover { background: #bfd9ee; }

/* Calendario */
.calendario { display: flex; flex-direction: column; gap: 8px; }
.cal-mes {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; background: var(--bg); border-radius: 8px;
  border-left: 3px solid var(--border);
}
.cal-mes.pagado { border-left-color: var(--green); background: var(--green-bg); }
.cal-mes.pendiente { border-left-color: var(--yellow); background: var(--yellow-bg); }
.cal-mes.vencido { border-left-color: var(--red); background: var(--red-bg); }
.cal-mes-info { display: flex; align-items: center; gap: 12px; }
.cal-icon {
  width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; font-size: 14px;
}
.cal-mes.pagado .cal-icon { background: var(--green); color: #fff; }
.cal-mes.pendiente .cal-icon { background: var(--yellow); color: #fff; }
.cal-mes.vencido .cal-icon { background: var(--red); color: #fff; }
.cal-texto { font-size: 14px; font-weight: 600; color: var(--text); }
.cal-monto {
  font-family: var(--mono); font-size: 15px; font-weight: 700; color: var(--navy);
}

/* Documentos */
.doc-list { display: flex; flex-direction: column; gap: 10px; }
.doc-item {
  display: flex; align-items: center; gap: 12px; padding: 12px 14px;
  background: var(--bg); border-radius: 8px; transition: background .2s;
}
.doc-item:hover { background: #e0ecf4; }
.doc-icon {
  width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
  background: var(--light); border-radius: 8px; color: var(--blue);
  flex-shrink: 0;
}
.doc-info { flex: 1; }
.doc-nombre { font-size: 14px; font-weight: 600; color: var(--text); }
.doc-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
.doc-link {
  color: var(--mid); text-decoration: none; font-size: 13px; font-weight: 600;
}
.doc-link:hover { text-decoration: underline; }

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(10, 20, 32, .6);
  z-index: 200; align-items: center; justify-content: center; padding: 20px;
  backdrop-filter: blur(2px);
}
.modal {
  background: #fff; border-radius: 16px; width: 100%; max-width: 460px;
  box-shadow: 0 24px 80px rgba(0,0,0,.3); max-height: 90vh; overflow-y: auto;
}
.modal-header {
  padding: 24px 28px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.modal-title {
  font-size: 18px; font-weight: 700; color: var(--navy);
}
.modal-subtitle {
  font-size: 13px; color: var(--muted); margin-top: 3px;
}
.btn-close {
  background: none; border: none; color: var(--muted); cursor: pointer;
  font-size: 24px; line-height: 1; padding: 4px;
}
.btn-close:hover { color: var(--text); }
.modal-body {
  padding: 24px 28px;
}
.modal-footer {
  padding: 20px 28px; border-top: 1px solid var(--border);
  display: flex; gap: 12px; justify-content: flex-end;
}
.btn-secondary {
  padding: 12px 22px; background: var(--bg); color: var(--text);
  border: 1px solid var(--border); border-radius: 8px; font-family: var(--font);
  font-size: 14px; font-weight: 600; cursor: pointer;
}
.btn-secondary:hover { background: var(--light); }
.metodo-pago {
  display: flex; align-items: center; gap: 14px; padding: 16px; border: 2px solid var(--border);
  border-radius: 10px; cursor: pointer; transition: all .2s; margin-bottom: 12px;
}
.metodo-pago:hover { border-color: var(--mid); background: var(--bg); }
.metodo-pago.seleccionado {
  border-color: var(--mid); background: rgba(45, 126, 168, .05);
}
.metodo-radio {
  width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 50%;
  position: relative; flex-shrink: 0;
}
.metodo-pago.seleccionado .metodo-radio {
  border-color: var(--mid);
}
.metodo-pago.seleccionado .metodo-radio::after {
  content: ''; position: absolute; inset: 3px; background: var(--mid);
  border-radius: 50%;
}
.metodo-info h4 {
  font-size: 15px; font-weight: 700; color: var(--navy); margin-bottom: 3px;
}
.metodo-info p {
  font-size: 12px; color: var(--muted);
}
.form-tarjeta {
  display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);
}
.form-tarjeta.activo { display: block; }
.input-group {
  margin-bottom: 16px;
}
.input-group label {
  display: block; font-size: 12px; font-weight: 600; color: var(--blue);
  text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px;
}
.input-group input {
  width: 100%; padding: 12px 14px; border: 1.5px solid var(--border);
  border-radius: 8px; font-family: var(--font); font-size: 14px;
  outline: none;
}
.input-group input:focus { border-color: var(--mid); }
.input-row {
  display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
}
.alerta {
  padding: 12px 16px; border-radius: 8px; font-size: 13px; margin-top: 16px;
  display: none;
}
.alerta.exito {
  background: var(--green-bg); color: var(--green); display: block;
}
.alerta.error {
  background: var(--red-bg); color: var(--red); display: block;
}
.info-spei {
  display: none; background: var(--bg); border-radius: 10px; padding: 18px;
  margin-top: 20px; border-left: 3px solid var(--mid);
}
.info-spei.activo { display: block; }
.info-spei-item {
  margin-bottom: 14px;
}
.info-spei-item:last-child { margin-bottom: 0; }
.info-spei-label {
  font-size: 11px; text-transform: uppercase; letter-spacing: .6px;
  color: var(--muted); font-weight: 600; margin-bottom: 4px;
}
.info-spei-valor {
  font-family: var(--mono); font-size: 15px; font-weight: 700;
  color: var(--navy); display: flex; align-items: center; gap: 8px;
}
.btn-copiar {
  padding: 4px 10px; background: var(--light); border: 1px solid var(--border);
  border-radius: 6px; font-size: 11px; font-weight: 600; color: var(--blue);
  cursor: pointer; font-family: var(--font);
}
.btn-copiar:hover { background: #bfd9ee; }

/* Responsive */
@media (max-width: 640px) {
  .dash-main { padding: 24px 16px 60px; }
  .card { padding: 20px; }
  .card-grid { grid-template-columns: 1fr; }
  .input-row { grid-template-columns: 1fr; }
  .dash-header { padding: 0 20px; }
}
</style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <img src="https://raw.githubusercontent.com/RohmnosGrupo/financiamiento-norlab/main/norlab_isotipo_transp.png" alt="NORLAB" onerror="this.style.display='none'">
    </div>
    <div class="login-title">Bienvenido a tu portal</div>
    <div class="login-sub">Consulta tu saldo, historial de pagos y documentos.</div>
    <div class="field">
      <label>Folio de contrato</label>
      <input type="text" id="inp-folio" placeholder="NL-XXXXX">
    </div>
    <div class="field">
      <label>Correo electrÃ³nico</label>
      <input type="email" id="inp-email" placeholder="tu@correo.com">
    </div>
    <button class="btn-primary" id="btn-login" onclick="doLogin()">Ingresar</button>
    <div class="login-error" id="login-error"></div>
  </div>
</div>

<!-- â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="dashboard">
  <div class="dash-header">
    <div class="dash-header-logo">
      <img src="https://raw.githubusercontent.com/RohmnosGrupo/financiamiento-norlab/main/norlab_logo_blanco_transp.png" alt="NORLAB" onerror="this.style.display='none'">
    </div>
    <div class="dash-header-right">
      <div class="folio-badge" id="folio-display"></div>
      <button class="btn-logout" onclick="doLogout()">Cerrar sesiÃ³n</button>
    </div>
  </div>

  <div class="dash-main">
    <div class="dash-welcome" id="welcome-msg">Â¡Hola!</div>
    <div class="dash-sub">Este es el resumen de tu contrato de financiamiento.</div>

    <!-- Resumen -->
    <div class="card">
      <div class="card-title">Resumen de tu contrato</div>
      <div class="card-grid">
        <div class="stat-box">
          <div class="stat-value" id="saldo-total">â€”</div>
          <div class="stat-label">Saldo total</div>
        </div>
        <div class="stat-box green">
          <div class="stat-value" id="pagos-realizados">â€”</div>
          <div class="stat-label">Pagos realizados</div>
        </div>
        <div class="stat-box yellow">
          <div class="stat-value" id="proximo-pago">â€”</div>
          <div class="stat-label">PrÃ³ximo pago</div>
        </div>
      </div>
      <button class="btn-pago" onclick="abrirModal()" style="margin-top:20px">
        ğŸ’³ Realizar pago
      </button>
    </div>

    <!-- Calendario de pagos -->
    <div class="card">
      <div class="card-title">Calendario de pagos</div>
      <div class="calendario" id="calendario">
        <div style="color:var(--muted);font-size:13px">Cargando informaciÃ³n...</div>
      </div>
    </div>

    <!-- Documentos -->
    <div style="display:grid;grid-template-columns:1fr;gap:20px">
      <div class="card">
        <div class="card-title">Documentos de tu contrato</div>
        <div class="doc-list" id="doc-list">
          <div style="color:var(--muted);font-size:13px">Cargando documentos...</div>
        </div>
      </div>
      <div class="card" style="margin-top:20px">
        <div class="card-title">Â¿Necesitas algo?</div>
        <p style="font-size:14px;color:var(--muted);margin-bottom:16px">
          ComunÃ­cate con tu ejecutivo NORLAB para cualquier duda sobre tu contrato.
        </p>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <a href="mailto:contacto@norlab.mx" class="btn-descargar" style="text-decoration:none">
            âœ‰ contacto@norlab.mx
          </a>
          <a href="https://wa.me/525621836094" target="_blank" class="btn-descargar" style="text-decoration:none;background:#e8faf0;color:#0d7c66">
            WhatsApp +52 56 2183 6094
          </a>
        </div>
      </div>
    </div>

  </div><!-- /dash-main -->
</div><!-- /dashboard -->

<!-- â”€â”€ MODAL PAGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)cerrarModal()">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modal-title">Realizar pago</div>
        <div class="modal-subtitle" id="modal-subtitle">Elige tu mÃ©todo de pago</div>
      </div>
      <button class="btn-close" onclick="cerrarModal()">&times;</button>
    </div>
    <div class="modal-body">
      
      <!-- MÃ©todos de pago -->
      <div class="metodo-pago" onclick="seleccionarMetodo('tarjeta')">
        <div class="metodo-radio"></div>
        <div class="metodo-info">
          <h4>ğŸ’³ Tarjeta de crÃ©dito o dÃ©bito</h4>
          <p>Pago inmediato con cargo automÃ¡tico</p>
        </div>
      </div>

      <div class="metodo-pago" onclick="seleccionarMetodo('spei')">
        <div class="metodo-radio"></div>
        <div class="metodo-info">
          <h4>ğŸ¦ Transferencia SPEI</h4>
          <p>Genera tu referencia para pagar desde tu banco</p>
        </div>
      </div>

      <!-- Formulario tarjeta -->
      <div class="form-tarjeta" id="form-tarjeta">
        <div class="input-group">
          <label>Monto a pagar (MXN)</label>
          <input type="number" id="monto-pago" placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="input-group">
          <label>NÃºmero de tarjeta</label>
          <input type="text" id="card-number" data-conekta="card[number]" maxlength="19" placeholder="4242 4242 4242 4242">
        </div>
        <div class="input-group">
          <label>Titular de la tarjeta</label>
          <input type="text" id="card-name" data-conekta="card[name]" placeholder="NOMBRE APELLIDO">
        </div>
        <div class="input-row">
          <div class="input-group">
            <label>Vencimiento (MM/AA)</label>
            <input type="text" id="card-exp" maxlength="5" placeholder="12/25">
          </div>
          <div class="input-group">
            <label>CVV</label>
            <input type="text" id="card-cvv" data-conekta="card[cvc]" maxlength="4" placeholder="123">
          </div>
        </div>
        <div class="alerta" id="alerta-tarjeta"></div>
      </div>

      <!-- Info SPEI -->
      <div class="info-spei" id="info-spei">
        <p style="font-size:13px;color:var(--muted);margin-bottom:16px">
          Usa estos datos para realizar tu transferencia SPEI desde tu banco:
        </p>
        <div class="info-spei-item">
          <div class="info-spei-label">Referencia de pago</div>
          <div class="info-spei-valor">
            <span id="spei-ref">Generando...</span>
            <button class="btn-copiar" onclick="copiar('spei-ref')">Copiar</button>
          </div>
        </div>
        <div class="info-spei-item">
          <div class="info-spei-label">CLABE interbancaria</div>
          <div class="info-spei-valor">
            <span id="spei-clabe">646180111800000011</span>
            <button class="btn-copiar" onclick="copiar('spei-clabe')">Copiar</button>
          </div>
        </div>
        <div class="info-spei-item">
          <div class="info-spei-label">Monto</div>
          <div class="info-spei-valor" id="spei-monto">$0.00 MXN</div>
        </div>
        <p style="font-size:12px;color:var(--muted);margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
          â± Tu pago se acreditarÃ¡ automÃ¡ticamente en 1-2 horas hÃ¡biles.
        </p>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
      <button class="btn-primary" id="btn-confirmar" onclick="procesarPago()" disabled>
        Continuar
      </button>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx73WrSGyDvEkqwxStUXk3avi3C1gAcPsiWu4KoYFixdwkuCQuT3CwgP2sT4ezyHY4X/exec';

let session = null;   // { folio, email, data }
let metodoSeleccionado = null;

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('inp-folio').addEventListener('keydown', function(e){
  if (e.key === 'Enter') document.getElementById('inp-email').focus();
});
document.getElementById('inp-email').addEventListener('keydown', function(e){
  if (e.key === 'Enter') doLogin();
});

function doLogin() {
  var folio = document.getElementById('inp-folio').value.trim().toUpperCase();
  var email = document.getElementById('inp-email').value.trim().toLowerCase();
  var btn = document.getElementById('btn-login');
  
  if (!folio || !email) { showLoginError('Ingresa tu folio y correo.'); return; }
  
  btn.disabled = true; btn.textContent = 'Verificando...';
  
  fetch(SCRIPT_URL + '?action=cliente_login&folio=' + encodeURIComponent(folio) + '&email=' + encodeURIComponent(email) + '&ts=' + Date.now())
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        session = { folio: folio, email: email, data: d };
        mostrarDashboard();
      } else {
        showLoginError(d.error || 'Folio o correo incorrecto.');
      }
    })
    .catch(e => { showLoginError('Error de conexiÃ³n. Intenta de nuevo.'); console.error(e); })
    .finally(() => { btn.disabled = false; btn.textContent = 'Ingresar'; });
}

function showLoginError(msg) {
  var el = document.getElementById('login-error');
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 5000);
}

function doLogout() {
  session = null;
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('inp-folio').value = '';
  document.getElementById('inp-email').value = '';
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mostrarDashboard() {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  
  var d = session.data;
  document.getElementById('folio-display').textContent = session.folio;
  document.getElementById('welcome-msg').textContent = 'Â¡Hola, ' + (d.nombre || 'Cliente') + '!';
  
  document.getElementById('saldo-total').textContent = '$' + (d.saldo || 0).toLocaleString('es-MX', {minimumFractionDigits:2});
  document.getElementById('pagos-realizados').textContent = (d.pagos_realizados || 0);
  document.getElementById('proximo-pago').textContent = d.proximo_pago || 'â€”';
  
  renderCalendario(d.calendario || []);
  renderDocumentos(d.documentos || []);
}

function renderCalendario(cal) {
  var html = '';
  cal.forEach(p => {
    var clase = p.estado === 'pagado' ? 'pagado' : (p.vencido ? 'vencido' : 'pendiente');
    var icono = p.estado === 'pagado' ? 'âœ“' : (p.vencido ? '!' : p.mes);
    html += '<div class="cal-mes ' + clase + '">';
    html += '  <div class="cal-mes-info">';
    html += '    <div class="cal-icon">' + icono + '</div>';
    html += '    <div class="cal-texto">' + p.fecha + '</div>';
    html += '  </div>';
    html += '  <div class="cal-monto">$' + Number(p.monto || 0).toLocaleString('es-MX', {minimumFractionDigits:2}) + '</div>';
    html += '</div>';
  });
  document.getElementById('calendario').innerHTML = html || '<div style="color:var(--muted);font-size:13px">Sin pagos programados.</div>';
}

function renderDocumentos(docs) {
  var html = '';
  docs.forEach(doc => {
    html += '<div class="doc-item">';
    html += '  <div class="doc-icon">ğŸ“„</div>';
    html += '  <div class="doc-info">';
    html += '    <div class="doc-nombre">' + doc.nombre + '</div>';
    html += '    <div class="doc-meta">' + (doc.fecha || '') + '</div>';
    html += '  </div>';
    html += '  <a href="' + doc.url + '" target="_blank" class="doc-link">Ver</a>';
    html += '</div>';
  });
  document.getElementById('doc-list').innerHTML = html || '<div style="color:var(--muted);font-size:13px">Sin documentos disponibles.</div>';
}

// â”€â”€ MODAL PAGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function abrirModal() {
  document.getElementById('modal-overlay').style.display = 'flex';
  metodoSeleccionado = null;
  document.querySelectorAll('.metodo-pago').forEach(el => el.classList.remove('seleccionado'));
  document.getElementById('form-tarjeta').classList.remove('activo');
  document.getElementById('info-spei').classList.remove('activo');
  document.getElementById('btn-confirmar').disabled = true;
  limpiarFormulario();
}

function cerrarModal() {
  document.getElementById('modal-overlay').style.display = 'none';
}

function seleccionarMetodo(metodo) {
  metodoSeleccionado = metodo;
  document.querySelectorAll('.metodo-pago').forEach(el => el.classList.remove('seleccionado'));
  event.currentTarget.classList.add('seleccionado');
  
  if (metodo === 'tarjeta') {
    document.getElementById('form-tarjeta').classList.add('activo');
    document.getElementById('info-spei').classList.remove('activo');
    document.getElementById('btn-confirmar').textContent = 'Pagar ahora';
    document.getElementById('btn-confirmar').disabled = false;
  } else if (metodo === 'spei') {
    document.getElementById('form-tarjeta').classList.remove('activo');
    document.getElementById('info-spei').classList.add('activo');
    document.getElementById('btn-confirmar').textContent = 'Generar referencia SPEI';
    document.getElementById('btn-confirmar').disabled = false;
  }
}

function limpiarFormulario() {
  ['monto-pago', 'card-number', 'card-name', 'card-exp', 'card-cvv'].forEach(id => {
    var el = document.getElementById(id);
    if (el) el.value = '';
  });
  var alerta = document.getElementById('alerta-tarjeta');
  alerta.className = 'alerta';
  alerta.textContent = '';
}

// â”€â”€ PROCESAR PAGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function procesarPago() {
  if (metodoSeleccionado === 'tarjeta') {
    pagarConTarjeta();
  } else if (metodoSeleccionado === 'spei') {
    generarSPEI();
  }
}

function pagarConTarjeta() {
  var monto = parseFloat(document.getElementById('monto-pago').value);
  var cardNum = document.getElementById('card-number').value.replace(/\s/g, '');
  var cardName = document.getElementById('card-name').value.trim();
  var cardExp = document.getElementById('card-exp').value.trim();
  var cardCvv = document.getElementById('card-cvv').value.trim();
  
  if (!monto || monto <= 0) { mostrarAlerta('error', 'Ingresa un monto vÃ¡lido.'); return; }
  if (!cardNum || !cardName || !cardExp || !cardCvv) { mostrarAlerta('error', 'Completa todos los campos.'); return; }
  
  var expParts = cardExp.split('/');
  if (expParts.length !== 2) { mostrarAlerta('error', 'Formato de vencimiento invÃ¡lido (MM/AA).'); return; }
  var expMonth = expParts[0].trim();
  var expYear = expParts[1].trim();
  
  if (!window.Conekta) { mostrarAlerta('error', 'Sistema de pagos no disponible. Recarga la pÃ¡gina.'); return; }
  
  var btn = document.getElementById('btn-confirmar');
  btn.disabled = true; btn.textContent = 'Procesando...';
  
  var tokenParams = {
    card: {
      number: cardNum,
      name: cardName,
      exp_year: '20' + expYear,
      exp_month: expMonth,
      cvc: cardCvv
    }
  };
  
  window.Conekta.Token.create(tokenParams, function(token) {
    fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'action=pago_tarjeta' +
        '&folio=' + encodeURIComponent(session.folio) +
        '&email=' + encodeURIComponent(session.email) +
        '&monto=' + monto +
        '&token=' + token.id
    })
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        mostrarAlerta('exito', 'âœ“ Pago procesado correctamente. ID: ' + (d.charge_id || ''));
        setTimeout(() => { cerrarModal(); recargarDatos(); }, 2500);
      } else {
        mostrarAlerta('error', d.error || 'Error al procesar el pago.');
      }
    })
    .catch(e => { mostrarAlerta('error', 'Error de conexiÃ³n.'); console.error(e); })
    .finally(() => { btn.disabled = false; btn.textContent = 'Pagar ahora'; });
    
  }, function(err) {
    mostrarAlerta('error', err.message_to_purchaser || 'Tarjeta invÃ¡lida.');
    btn.disabled = false; btn.textContent = 'Pagar ahora';
  });
}

function generarSPEI() {
  var btn = document.getElementById('btn-confirmar');
  btn.disabled = true; btn.textContent = 'Generando...';
  
  fetch(SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'action=pago_spei' +
      '&folio=' + encodeURIComponent(session.folio) +
      '&email=' + encodeURIComponent(session.email) +
      '&monto=' + (session.data.saldo || 0)
  })
  .then(r => r.json())
  .then(d => {
    if (d.ok) {
      document.getElementById('spei-ref').textContent = d.referencia;
      document.getElementById('spei-clabe').textContent = d.clabe;
      document.getElementById('spei-monto').textContent = '$' + Number(d.monto).toLocaleString('es-MX', {minimumFractionDigits:2}) + ' MXN';
      btn.textContent = 'Referencia generada';
    } else {
      mostrarAlerta('error', d.error || 'Error al generar referencia.');
      btn.disabled = false; btn.textContent = 'Generar referencia SPEI';
    }
  })
  .catch(e => {
    mostrarAlerta('error', 'Error de conexiÃ³n.');
    console.error(e);
    btn.disabled = false; btn.textContent = 'Generar referencia SPEI';
  });
}

function mostrarAlerta(tipo, msg) {
  var el = document.getElementById('alerta-tarjeta');
  el.className = 'alerta ' + tipo;
  el.textContent = msg;
  el.style.display = 'block';
}

function copiar(elId) {
  var el = document.getElementById(elId);
  if (!el) return;
  var txt = el.textContent;
  navigator.clipboard.writeText(txt).then(() => {
    event.target.textContent = 'âœ“ Copiado';
    setTimeout(() => { event.target.textContent = 'Copiar'; }, 2000);
  });
}

function recargarDatos() {
  fetch(SCRIPT_URL + '?action=cliente_login&folio=' + encodeURIComponent(session.folio) + '&email=' + encodeURIComponent(session.email) + '&ts=' + Date.now())
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        session.data = d;
        mostrarDashboard();
      }
    })
    .catch(e => console.error(e));
}

// Auto-formateo tarjeta
document.getElementById('card-number').addEventListener('input', function(e) {
  var val = e.target.value.replace(/\s/g, '');
  var formatted = val.match(/.{1,4}/g)?.join(' ') || val;
  e.target.value = formatted;
});

document.getElementById('card-exp').addEventListener('input', function(e) {
  var val = e.target.value.replace(/\D/g, '');
  if (val.length >= 2) {
    e.target.value = val.substring(0, 2) + '/' + val.substring(2, 4);
  } else {
    e.target.value = val;
  }
});

// Enter en folio/email
document.getElementById('inp-folio').addEventListener('keydown', function(e){ if(e.key==='Enter') document.getElementById('inp-email').focus(); });
document.getElementById('inp-email').addEventListener('keydown', function(e){ if(e.key==='Enter') doLogin(); });
</script>

</body>
</html>
