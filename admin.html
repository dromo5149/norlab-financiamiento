<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NORLAB &mdash; Panel de Expedientes</title>
<style>
:root{
  --navy:#0b1f3a;--blue:#2D7EA8;--blue2:#2A5870;
  --light:#f7f9fc;--border:#e8edf5;--text:#0F2430;
  --muted:#6b7c93;--green:#2e7d32;--red:#c62828;--yellow:#b45309;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--light);color:var(--text);min-height:100vh;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
@keyframes spin{to{transform:rotate(360deg)}}
nav{background:var(--navy);padding:0 28px;height:62px;display:flex;align-items:center;justify-content:space-between;}
.nav-logo{height:38px;object-fit:contain;}
.nav-title{color:rgba(255,255,255,.5);font-size:13px;font-weight:600;letter-spacing:.5px;}
#loginScreen{display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 62px);padding:24px;}
.login-box{background:#fff;border-radius:20px;padding:40px;width:100%;max-width:380px;border:1px solid var(--border);box-shadow:0 8px 40px rgba(0,0,0,.08);animation:fadeUp .3s ease;}
.login-box h2{font-size:20px;font-weight:700;color:var(--navy);margin-bottom:6px;}
.login-box p{font-size:13px;color:var(--muted);margin-bottom:24px;}
.login-box input{width:100%;border:1.5px solid var(--border);border-radius:10px;padding:11px 14px;font-size:14px;font-family:inherit;outline:none;margin-bottom:12px;}
.login-box input:focus{border-color:var(--blue);}
.btn-login{width:100%;background:var(--blue);color:#fff;border:none;border-radius:10px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;}
.btn-login:hover:not(:disabled){background:var(--blue2);}
.btn-login:disabled{opacity:.6;cursor:not-allowed;}
#loginErr{color:var(--red);font-size:12px;margin-top:8px;min-height:16px;}
#mainScreen{display:none;animation:fadeUp .3s ease;}
.toolbar{background:#fff;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.toolbar-title{font-size:16px;font-weight:700;color:var(--navy);flex:1;}
.search-box{display:flex;align-items:center;gap:8px;background:var(--light);border:1.5px solid var(--border);border-radius:10px;padding:8px 12px;min-width:220px;}
.search-box input{border:none;background:none;font-size:13px;font-family:inherit;outline:none;width:100%;}
.filter-sel{border:1.5px solid var(--border);border-radius:10px;padding:8px 12px;font-size:13px;font-family:inherit;background:#fff;outline:none;color:var(--text);}
.btn-refresh{background:var(--blue);color:#fff;border:none;border-radius:10px;padding:9px 16px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px;}
.stats-bar{padding:16px 28px;display:flex;gap:12px;flex-wrap:wrap;}
.stat-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px 18px;min-width:120px;flex:1;}
.stat-n{font-size:28px;font-weight:800;color:var(--navy);line-height:1;}
.stat-l{font-size:11px;color:var(--muted);margin-top:4px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;}
.stat-card.green{border-color:#a5d6a7;background:#f1f8e9;} .stat-card.green .stat-n{color:var(--green);}
.stat-card.yellow{border-color:#ffe082;background:#fffde7;} .stat-card.yellow .stat-n{color:var(--yellow);}
.stat-card.red{border-color:#ef9a9a;background:#ffebee;} .stat-card.red .stat-n{color:var(--red);}
.stat-card.blue{border-color:#90caf9;background:#e3f2fd;} .stat-card.blue .stat-n{color:var(--blue);}
.table-wrap{padding:0 28px 28px;overflow-x:auto;}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden;border:1px solid var(--border);}
th{background:var(--navy);color:#fff;padding:11px 14px;font-size:11px;font-weight:700;text-align:left;letter-spacing:.5px;text-transform:uppercase;white-space:nowrap;}
td{padding:11px 14px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:#f8fafc;cursor:pointer;}
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap;}
.badge-green{background:#e8f5e9;color:var(--green);}
.badge-yellow{background:#fff8e1;color:var(--yellow);}
.badge-red{background:#ffebee;color:var(--red);}
.badge-blue{background:#e3f2fd;color:var(--blue);}
.badge-gray{background:#f5f5f5;color:#666;}
.score-bar{display:flex;align-items:center;gap:8px;}
.score-track{flex:1;height:6px;background:#e8edf5;border-radius:3px;min-width:60px;}
.score-fill{height:100%;border-radius:3px;}
#detailOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;}
#detailPanel{display:none;position:fixed;right:0;top:0;bottom:0;width:500px;max-width:95vw;background:#fff;box-shadow:-4px 0 32px rgba(0,0,0,.15);overflow-y:auto;z-index:201;}
.dp-head{background:var(--navy);padding:20px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
.dp-head h3{color:#fff;font-size:16px;font-weight:700;}
.dp-close{background:none;border:none;color:rgba(255,255,255,.7);cursor:pointer;font-size:24px;line-height:1;}
.dp-close:hover{color:#fff;}
.dp-body{padding:20px 24px;}
.dp-section{margin-bottom:20px;}
.dp-section-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.dp-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid #f5f7fa;}
.dp-row:last-child{border-bottom:none;}
.dp-row span:first-child{color:var(--muted);flex:0 0 140px;}
.dp-row span:last-child{font-weight:600;text-align:right;flex:1;}
.score-big{text-align:center;padding:20px;background:var(--light);border-radius:12px;margin-bottom:16px;}
.score-big .sn{font-size:48px;font-weight:900;line-height:1;}
.score-big .sl{font-size:13px;color:var(--muted);margin-top:6px;}
.score-big .rec{margin-top:10px;font-size:14px;font-weight:700;}
.status-select{border:1.5px solid var(--border);border-radius:9px;padding:9px 12px;font-size:13px;font-family:inherit;width:100%;margin-bottom:8px;background:#fff;}
.nota-input{border:1.5px solid var(--border);border-radius:9px;padding:9px 12px;font-size:13px;font-family:inherit;width:100%;min-height:72px;resize:vertical;margin-bottom:8px;}
.btn-save{background:var(--blue);color:#fff;border:none;border-radius:9px;padding:10px 20px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;width:100%;}
.file-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:12px;}
.file-item a{color:var(--blue);text-decoration:none;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-drive{display:flex;align-items:center;gap:6px;background:#e3f2fd;color:var(--blue2);border:1px solid #90caf9;border-radius:8px;padding:8px 14px;font-size:12px;font-weight:700;text-decoration:none;margin-bottom:12px;}
.empty-state{text-align:center;padding:48px 20px;color:var(--muted);}
.loading-spinner{display:flex;align-items:center;justify-content:center;gap:10px;padding:48px;color:var(--muted);font-size:14px;}
.notes-log{background:var(--light);border-radius:8px;padding:10px 12px;font-size:12px;color:var(--muted);white-space:pre-wrap;line-height:1.6;max-height:100px;overflow-y:auto;margin-bottom:8px;}

/* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs-bar{background:#fff;border-bottom:2px solid var(--border);padding:0 28px;display:flex;gap:0;}
.tab-btn{padding:14px 20px;font-size:13px;font-weight:700;color:var(--muted);border:none;border-bottom:3px solid transparent;background:none;cursor:pointer;font-family:inherit;letter-spacing:.3px;margin-bottom:-2px;}
.tab-btn.active{color:var(--blue2);border-bottom-color:var(--blue2);}
.tab-btn:hover:not(.active){color:var(--navy);}
.tab-panel{display:none;}
.tab-panel.active{display:block;}
/* â”€â”€ Contratos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ct-wrap{padding:20px 28px 40px;}
.ct-card{background:#fff;border:1px solid var(--border);border-radius:14px;margin-bottom:12px;overflow:hidden;}
.ct-card-head{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border);}
.ct-folio{font-size:13px;font-weight:800;color:var(--navy);}
.ct-name{font-size:13px;color:var(--text);flex:1;}
.ct-equipo{font-size:12px;color:var(--muted);}
.ct-card-body{padding:14px 18px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
.ct-badge-pend{background:#e3f2fd;color:#1565C0;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;}
.ct-badge-rev{background:#fff8e1;color:#b45309;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;}
.ct-badge-sign{background:#e8f5e9;color:#2e7d32;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;}
.ct-badge-firmado{background:#1b5e20;color:#fff;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;}
.ct-doc-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding:4px 0;border-bottom:1px solid #f0f4f8;}
.ct-btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:9px;font-size:12px;font-weight:700;border:1.5px solid;cursor:pointer;font-family:inherit;text-decoration:none;}
.ct-btn-gdoc{background:#e8f0fe;color:#1a73e8;border-color:#a8c7fa;}
.ct-btn-word{background:#e8f5e9;color:#2e7d32;border-color:#a5d6a7;}
.ct-btn-sign{background:var(--blue);color:#fff;border-color:var(--blue);}
.ct-btn-sign:disabled{opacity:.5;cursor:not-allowed;}
.ct-upload-area{display:flex;align-items:center;gap:8px;flex:1;min-width:200px;}
.ct-upload-input{font-size:12px;font-family:inherit;border:1.5px solid var(--border);border-radius:9px;padding:6px 10px;flex:1;min-width:0;}
.ct-btn-upload{background:var(--blue2);color:#fff;border:none;border-radius:9px;padding:7px 14px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;}
.ct-btn-upload:disabled{opacity:.5;cursor:not-allowed;}
.ct-msg{font-size:12px;padding:4px 10px;border-radius:6px;}
.ct-msg-ok{background:#e8f5e9;color:#2e7d32;}
.ct-msg-err{background:#ffebee;color:#c62828;}
</style>
</head>
<body>

<nav>
  <img class="nav-logo" src="https://raw.githubusercontent.com/RohmnosGrupo/financiamiento-norlab/main/norlab_logo_blanco_transp.png" alt="NORLAB" onerror="this.style.display='none'">
  <span class="nav-title">Panel de Expedientes</span>
</nav>

<div id="loginScreen">
  <div class="login-box">
    <h2>Acceso al panel</h2>
    <p>Ingresa la contrase&ntilde;a de administrador.</p>
    <input type="password" id="pwdInput" placeholder="Contrase&ntilde;a" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn-login" onclick="doLogin()">Ingresar</button>
    <div id="loginErr"></div>
  </div>
</div>

<div id="mainScreen">
  <!-- TAB NAVIGATION -->
  <div class="tabs-bar">
    <button class="tab-btn active" onclick="switchTab('solicitudes')">Solicitudes</button>
    <button class="tab-btn" onclick="switchTab('contratos')" id="tabBtnContratos">Contratos</button>
    <button class="tab-btn" onclick="switchTab('reactivos')" id="tabBtnReactivos">Cat&aacute;logo Reactivos</button>
  </div>

  <!-- TAB: SOLICITUDES -->
  <div id="tabSolicitudes" class="tab-panel active">
  <div class="toolbar">
    <div class="toolbar-title">Solicitudes de Financiamiento</div>
    <div class="search-box">
      <svg viewBox="0 0 24 24" width="15" height="15" stroke="#6b7c93" stroke-width="2" fill="none"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="searchInput" placeholder="Buscar nombre, folio, equipo..." oninput="filterTable()">
    </div>
    <select class="filter-sel" id="filterEstado" onchange="filterTable()">
      <option value="">Todos los estados</option>
      <option>Pendiente</option>
      <option>En revision</option>
      <option>Docs incompletos</option>
      <option>Pre-aprobado</option>
      <option>Aprobado</option>
      <option>Rechazado</option>
    </select>
    <select class="filter-sel" id="filterPlan" onchange="filterTable()">
      <option value="">Todos los planes</option>
      <option>Financiamiento</option>
      <option>Renta mensual</option>
      <option>Comodato</option>
    </select>
    <button class="btn-refresh" onclick="loadData()">
      <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
      Actualizar
    </button>
  </div>
  <div class="stats-bar" id="statsBar"></div>
  <div class="table-wrap">
    <div id="tableArea"><div class="loading-spinner">Esperando...</div></div>
  </div>
  </div><!-- /tabSolicitudes -->

  <!-- TAB: CONTRATOS -->
  <div id="tabContratos" class="tab-panel">
    <div class="ct-wrap">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <div>
          <div style="font-size:16px;font-weight:700;color:var(--navy)">ğŸ“„ GestiÃ³n de Contratos</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px">Genera y envÃ­a contratos para expedientes aprobados</div>
        </div>
        <div style="display:flex;gap:10px;">
          <select id="filtroEstadoContrato" onchange="filtrarContratos()" style="padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;">
            <option value="">Todos los estados</option>
            <option value="Pendiente GeneraciÃ³n">â³ Pendiente</option>
            <option value="Generado">ğŸ“ Generado</option>
            <option value="Enviado a Firma">ğŸ“§ Enviado</option>
            <option value="Firmado">âœ… Firmado</option>
          </select>
          <button class="btn-refresh" onclick="loadContratos()">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Actualizar
          </button>
        </div>
      </div>
      <div id="contratosLoading" style="display:none;">
        <div class="loading-spinner">
          <svg viewBox="0 0 24 24" width="20" height="20" stroke="#2A5870" stroke-width="2" fill="none" style="animation:spin .8s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
          Cargando contratos...
        </div>
      </div>
      <div id="contratosEmpty" style="display:none;">
        <div class="empty-state">
          <div style="font-size:48px;margin-bottom:12px;">ğŸ“„</div>
          <div style="font-size:14px;font-weight:600;color:var(--text);">No hay expedientes con contratos</div>
          <div style="font-size:12px;margin-top:4px;">Los expedientes aprobados aparecerÃ¡n aquÃ­</div>
        </div>
      </div>
      <div id="contratosTable"></div>
    </div>
  </div><!-- /tabContratos -->


  <!-- TAB: REACTIVOS -->
  <div id="tabReactivos" class="tab-panel">
    <div class="ct-wrap">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <div>
          <div style="font-size:16px;font-weight:700;color:var(--navy)">Cat&aacute;logo de Reactivos &mdash; Precios Especiales Comodato</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px">Estos precios son visibles para el cliente en la solicitud de comodato. Gestiona el cat&aacute;logo desde la hoja "Reactivos" en Google Sheets.</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn-refresh" onclick="loadReactivos()">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Actualizar
          </button>
          <button style="border:none;border-radius:8px;padding:8px 16px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;background:var(--blue2);color:#fff;display:flex;align-items:center;gap:6px" onclick="showAddReactivoModal()">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Agregar reactivo
          </button>
        </div>
      </div>
      <div id="reactivosArea"><div class="loading-spinner">Haz clic en Actualizar para cargar el cat&aacute;logo</div></div>
    </div>
  </div><!-- /tabReactivos -->

  <!-- Modal agregar/editar reactivo -->
  <div id="reactivoModal" style="display:none;position:fixed;inset:0;background:rgba(10,22,32,.45);z-index:1100;display:none;align-items:center;justify-content:center">
    <div style="background:#fff;border-radius:14px;padding:24px;width:100%;max-width:440px;box-shadow:0 20px 60px rgba(0,0,0,.2)">
      <div style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:16px" id="reactivoModalTitle">Agregar reactivo</div>
      <div style="display:grid;gap:12px">
        <div><label style="font-size:12px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">Nombre del reactivo</label><input id="rx_nombre" style="width:100%;box-sizing:border-box;padding:10px 12px;border:1.5px solid #d6eaf5;border-radius:8px;font-size:13px;font-family:inherit" placeholder="Ej. Reactivo para glucosa COBAS"></div>
        <div><label style="font-size:12px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">Marca / modelo</label><input id="rx_marca" style="width:100%;box-sizing:border-box;padding:10px 12px;border:1.5px solid #d6eaf5;border-radius:8px;font-size:13px;font-family:inherit" placeholder="Ej. Roche / REF 123456"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><label style="font-size:12px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">Precio especial (MXN)</label><input id="rx_precio" type="number" style="width:100%;box-sizing:border-box;padding:10px 12px;border:1.5px solid #d6eaf5;border-radius:8px;font-size:13px;font-family:inherit" placeholder="0.00"></div>
          <div><label style="font-size:12px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">Unidad</label><input id="rx_unidad" style="width:100%;box-sizing:border-box;padding:10px 12px;border:1.5px solid #d6eaf5;border-radius:8px;font-size:13px;font-family:inherit" placeholder="kit / caja / frasco"></div>
        </div>
        <div><label style="font-size:12px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">Equipos compatibles</label><input id="rx_equipo" style="width:100%;box-sizing:border-box;padding:10px 12px;border:1.5px solid #d6eaf5;border-radius:8px;font-size:13px;font-family:inherit" placeholder="Ej. COBAS C111, COBAS B101"></div>
        <div><label style="font-size:12px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">Activo</label><select id="rx_activo" style="width:100%;box-sizing:border-box;padding:10px 12px;border:1.5px solid #d6eaf5;border-radius:8px;font-size:13px;font-family:inherit"><option value="si">S&iacute;</option><option value="no">No</option></select></div>
      </div>
      <div id="rx_modal_msg" style="display:none;margin-top:10px;font-size:12px;color:#c62828"></div>
      <div style="display:flex;gap:8px;margin-top:18px;justify-content:flex-end">
        <button onclick="closeReactivoModal()" style="border:1.5px solid #d6eaf5;border-radius:8px;padding:9px 18px;font-size:13px;font-weight:600;background:#fff;color:var(--navy);cursor:pointer;font-family:inherit">Cancelar</button>
        <button onclick="saveReactivo()" id="rx_save_btn" style="border:none;border-radius:8px;padding:9px 18px;font-size:13px;font-weight:600;background:var(--blue2);color:#fff;cursor:pointer;font-family:inherit">Guardar</button>
      </div>
    </div>
  </div>

</div>

<div id="detailOverlay" onclick="closeDetail()"></div>
<div id="detailPanel">
  <div class="dp-head">
    <h3 id="dp-title">Detalle</h3>
    <button class="dp-close" onclick="closeDetail()">&times;</button>
  </div>
  <div class="dp-body" id="dp-body"></div>
</div>

<script>
var SCRIPT = 'https://script.google.com/macros/s/AKfycbyQWCY3SzoYKlXG_HF7D-fll3Zi-5jYWXeaOkSAPi0zJpGO3T_C-DLpW-DQLuHDxasM/exec';
var allRows = [], userPwd = '';

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin(){
  var pwd = document.getElementById('pwdInput').value.trim();
  if(!pwd) return;
  var btn = document.querySelector('.btn-login');
  var err = document.getElementById('loginErr');
  err.style.display='none';
  btn.disabled=true; btn.textContent='Verificando...';

  callScript({action:'admin_list', pwd:pwd}, function(data){
    btn.disabled=false; btn.textContent='Ingresar';
    if(data.error==='No autorizado'){
      err.textContent = 'Contrasena incorrecta';
      err.style.display='block';
      return;
    }
    if(data.error){
      err.textContent = 'Error: '+data.error;
      err.style.display='block';
      return;
    }
    userPwd = pwd;
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('mainScreen').style.display='block';
    allRows = data.rows||[];
    renderStats();
    renderTable(allRows);
  });
}

// â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadData(){
  document.getElementById('tableArea').innerHTML='<div class="loading-spinner"><svg viewBox="0 0 24 24" width="20" height="20" stroke="#2A5870" stroke-width="2" fill="none" style="animation:spin .8s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Actualizando...</div>';
  callScript({action:'admin_list', pwd:userPwd}, function(data){
    allRows = data.rows||[];
    renderStats();
    filterTable();
  });
}

function callScript(params, cb, timeout){
  var qs=Object.keys(params).map(function(k){
    return encodeURIComponent(k)+'='+encodeURIComponent(params[k]);
  }).join('&');
  var controller=new AbortController();
  var to=setTimeout(function(){controller.abort();cb({error:'Timeout - sin respuesta del servidor'});}, timeout||10000);
  fetch(SCRIPT+'?'+qs+'&ts='+Date.now(), {signal:controller.signal})
    .then(function(r){return r.json();})
    .then(function(d){clearTimeout(to);cb(d);})
    .catch(function(e){clearTimeout(to);if(e.name!=='AbortError')cb({error:'Error de conexion: '+e.message});});
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats(){
  var total=allRows.length;
  var pendiente=allRows.filter(function(r){return (r['Estado']||'Pendiente')==='Pendiente';}).length;
  var aprobado=allRows.filter(function(r){return r['Estado']==='Aprobado'||r['Estado']==='Pre-aprobado';}).length;
  var revision=allRows.filter(function(r){return r['Estado']==='En revision';}).length;
  var rechazado=allRows.filter(function(r){return r['Estado']==='Rechazado';}).length;
  var avgScore=total>0?Math.round(allRows.reduce(function(s,r){return s+(Number(r['Score'])||0);},0)/total):0;

  document.getElementById('statsBar').innerHTML=
    stat(total,'Total solicitudes','blue')+
    stat(pendiente,'Pendientes','yellow')+
    stat(revision,'En revision','blue')+
    stat(aprobado,'Pre-aprobados / Aprobados','green')+
    stat(rechazado,'Rechazados','red')+
    stat(avgScore,'Score promedio','blue');
}
function stat(n,l,cls){
  return '<div class="stat-card '+cls+'"><div class="stat-n">'+n+'</div><div class="stat-l">'+l+'</div></div>';
}

// â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterTable(){
  var q=(document.getElementById('searchInput').value||'').toLowerCase();
  var est=document.getElementById('filterEstado').value;
  var plan=document.getElementById('filterPlan').value;
  var filtered=allRows.filter(function(r){
    var nombre=r['Nombre / Razon Social']||r['Nombre / RazÃ³n Social']||'';
    var matchQ=!q||
      (r['Folio']||'').toLowerCase().indexOf(q)>-1||
      nombre.toLowerCase().indexOf(q)>-1||
      (r['Equipo']||'').toLowerCase().indexOf(q)>-1||
      (r['Email']||'').toLowerCase().indexOf(q)>-1;
    var matchE=!est||(r['Estado']||'Pendiente')===est;
    var matchP=!plan||(r['Plan']||'')===plan;
    return matchQ&&matchE&&matchP;
  });
  renderTable(filtered);
}

function renderTable(rows){
  if(!rows.length){
    document.getElementById('tableArea').innerHTML='<div class="empty-state">'+
      '<svg viewBox="0 0 24 24" width="48" height="48" stroke="#ccc" stroke-width="1.5" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/></svg>'+
      '<br>No hay solicitudes que coincidan</div>';
    return;
  }
  var html='<table><thead><tr>'+
    '<th>Folio</th><th>Fecha</th><th>Cliente</th><th>Equipo</th><th>Plan</th>'+
    '<th>Score</th><th>Estado</th><th>Docs</th><th>Ciudad</th>'+
    '</tr></thead><tbody>';

  rows.forEach(function(r){
    var folio=r['Folio']||'';
    var fecha=String(r['Fecha']||'').substr(0,10);
    var nombre=r['Nombre / Razon Social']||r['Nombre / RazÃ³n Social']||'';
    var equipo=r['Equipo']||'';
    var plan=r['Plan']||'';
    var score=Number(r['Score'])||0;
    var estado=r['Estado']||'Pendiente';
    var docsOk=Number(r['Docs OK'])||0;
    var docsReq=Number(r['Docs Req'])||4;
    var ciudad=r['Ciudad']||'';
    var email=r['Email']||'';
    var scoreCls=score>=70?'#2e7d32':score>=40?'#b45309':'#c62828';
    var estadoBadge=badgeEstado(estado);
    var docsBadge=docsOk>=docsReq?
      '<span class="badge badge-green">'+docsOk+'/'+docsReq+'</span>':
      '<span class="badge badge-yellow">'+docsOk+'/'+docsReq+'</span>';

    html+='<tr onclick="openDetail(\''+folio+'\')">'+
      '<td><strong style="color:var(--navy)">'+folio+'</strong></td>'+
      '<td style="color:var(--muted)">'+fecha+'</td>'+
      '<td><div style="font-weight:600">'+nombre+'</div><div style="font-size:11px;color:var(--muted)">'+email+'</div></td>'+
      '<td>'+equipo+'</td>'+
      '<td><span style="font-size:12px">'+plan+'</span></td>'+
      '<td><div class="score-bar"><strong style="color:'+scoreCls+';font-size:15px;min-width:28px">'+score+'</strong>'+
        '<div class="score-track"><div class="score-fill" style="width:'+Math.min(score,100)+'%;background:'+scoreCls+'"></div></div></div></td>'+
      '<td>'+estadoBadge+'</td>'+
      '<td>'+docsBadge+'</td>'+
      '<td style="color:var(--muted);font-size:12px">'+ciudad+'</td>'+
      '</tr>';
  });
  html+='</tbody></table>';
  document.getElementById('tableArea').innerHTML=html;
}

function badgeEstado(e){
  var map={
    'Pendiente':'badge-yellow','En revision':'badge-blue','En revisiÃ³n':'badge-blue',
    'Docs incompletos':'badge-yellow','Pre-aprobado':'badge-green',
    'Aprobado':'badge-green','Rechazado':'badge-red'
  };
  return '<span class="badge '+(map[e]||'badge-gray')+'">'+e+'</span>';
}

// â”€â”€ Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openDetail(folio){
  document.getElementById('detailOverlay').style.display='block';
  document.getElementById('detailPanel').style.display='block';
  document.getElementById('dp-title').textContent=folio;
  document.getElementById('dp-body').innerHTML='<div class="loading-spinner"><svg viewBox="0 0 24 24" width="20" height="20" stroke="#2A5870" stroke-width="2" fill="none" style="animation:spin .8s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Cargando detalle...</div>';
  callScript({action:'admin_detail', pwd:userPwd, folio:folio}, function(d){
    if(d.error){document.getElementById('dp-body').innerHTML='<p style="color:red;padding:20px">'+d.error+'</p>';return;}
    renderDetail(d);
  });
}
function closeDetail(){
  document.getElementById('detailOverlay').style.display='none';
  document.getElementById('detailPanel').style.display='none';
}

function renderDetail(d){
  var score=Number(d['Score'])||0;
  var rec=(d['Recomendacion']||d['RecomendaciÃ³n']||'').replace(/[\u2705\u{1F7E1}\u{1F534}]/gu,'').trim();
  var scoreCls=score>=70?'var(--green)':score>=40?'var(--yellow)':'var(--red)';
  var recIcon=score>=70?'Pre-aprobado':score>=40?'Revisar':'No procede';

  var filesHtml='';
  if(d._drive_url){
    filesHtml+='<a class="btn-drive" href="'+d._drive_url+'" target="_blank">'+
      '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="1.8" fill="none"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>'+
      'Abrir carpeta en Drive</a>';
  }
  var files=d._files||[];
  if(files.length){
    files.forEach(function(f){
      filesHtml+='<div class="file-item">'+
        '<svg viewBox="0 0 24 24" width="16" height="16" stroke="#2A5870" stroke-width="1.8" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>'+
        '<a href="'+f.url+'" target="_blank">'+f.name+'</a>'+
        '</div>';
    });
  }else{
    filesHtml+='<p style="font-size:12px;color:var(--muted)">Sin documentos subidos.</p>';
    if(d._debug_folders){
      filesHtml+='<p style="font-size:11px;color:#b45309;margin-top:6px">'+d._debug_folders+'</p>';
    }
    if(d._folder_mismatch){
      filesHtml+='<p style="font-size:11px;color:#b45309;font-weight:700;margin-top:6px">&#9888; '+d._folder_mismatch+'</p>';
    }
  }

  var notas=d['Notas']||'';
  var notasHtml=notas?'<div class="notes-log">'+notas+'</div>':'';

  var nombre=d['Nombre / Razon Social']||d['Nombre / RazÃ³n Social']||'';
  var tel=d['Telefono']||d['TelÃ©fono']||'';
  var anos=d['Anos operacion']||d['AÃ±os operaciÃ³n']||'';
  var ultima=d['Zoho: Ultima compra']||d['Zoho: Ãšltima compra']||'-';
  var saldo = d['Zoho: Saldo pendiente'];
  var diasVencido = Number(d['Zoho: DÃ­as vencido'] || d['Zoho: Dias vencido']) || 0;
  var saldoStr = saldo > 0
    ? '$' + Number(saldo).toLocaleString('es-MX') + (diasVencido > 0 ? ' <span style="color:' + (diasVencido > 15 ? '#c62828' : '#f57c00') + ';font-weight:700">' + diasVencido + ' dÃ­as vencido' + (diasVencido > 15 ? ' âš ï¸' : '') + '</span>' : '')
    : '$0';

  document.getElementById('dp-body').innerHTML=
    '<div class="score-big">'+
      '<div class="sn" style="color:'+scoreCls+'">'+score+'<span style="font-size:20px;color:var(--muted)">/100</span></div>'+
      '<div class="sl">Score de evaluacion automatica</div>'+
      '<div class="rec" style="color:'+scoreCls+'">'+recIcon+'</div>'+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Plan solicitado</div>'+
      row2('Equipo',d['Equipo'])+row2('Plan',d['Plan'])+row2('Plazo',d['Plazo']?d['Plazo']+' meses':'')+
      // Campos editables para Mensualidad y Enganche
      (function(){
        var mensualidadVal = parseFloat(String(d['Mensualidad']||'').replace(/[^0-9.-]/g, '')) || 0;
        var engancheVal = parseFloat(String(d['Enganche']||'').replace(/[^0-9.-]/g, '')) || 0;
        return '<div class="dp-row">'+
          '<span>Mensualidad</span>'+
          '<div style="display:flex;gap:6px;align-items:center;flex:1;justify-content:flex-end">'+
            '<span style="font-size:13px;color:var(--muted)">$</span>'+
            '<input type="number" id="edit_mensualidad_'+d['Folio']+'" value="'+mensualidadVal+'" '+
              'style="width:120px;padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;'+
              'font-size:13px;font-weight:600;text-align:right;font-family:inherit" step="0.01" min="0">'+
            '<button onclick="guardarMonto(\''+d['Folio']+'\',\'Mensualidad\')" '+
              'style="padding:5px 10px;background:var(--blue2);color:#fff;border:none;border-radius:6px;'+
              'font-size:11px;font-weight:600;cursor:pointer;font-family:inherit">Guardar</button>'+
          '</div>'+
        '</div>'+
        '<div class="dp-row" style="border-bottom:none">'+
          '<span>Enganche</span>'+
          '<div style="display:flex;gap:6px;align-items:center;flex:1;justify-content:flex-end">'+
            '<span style="font-size:13px;color:var(--muted)">$</span>'+
            '<input type="number" id="edit_enganche_'+d['Folio']+'" value="'+engancheVal+'" '+
              'style="width:120px;padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;'+
              'font-size:13px;font-weight:600;text-align:right;font-family:inherit" step="0.01" min="0">'+
            '<button onclick="guardarMonto(\''+d['Folio']+'\',\'Enganche\')" '+
              'style="padding:5px 10px;background:var(--blue2);color:#fff;border:none;border-radius:6px;'+
              'font-size:11px;font-weight:600;cursor:pointer;font-family:inherit">Guardar</button>'+
          '</div>'+
        '</div>'+
        '<div id="msg_montos_'+d['Folio']+'" style="font-size:11px;margin-top:6px;display:none"></div>';
      })()+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Solicitante</div>'+
      row2('Nombre',nombre)+row2('Tipo',d['Tipo'])+row2('RFC',d['RFC'])+row2('Telefono',tel)+row2('Email',d['Email'])+row2('Ciudad',d['Ciudad'])+row2('Negocio',d['Negocio / Empresa'])+row2('Antiguedad',anos)+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Historial Zoho</div>'+
      row2('Cliente',d['Zoho: Cliente'])+
      row2('Total compras',d['Zoho: Total compras']?'$'+Number(d['Zoho: Total compras']).toLocaleString('es-MX'):'')+
      row2('Facturas pagadas',d['Zoho: Facturas pagadas'])+
      row2('Ultima compra',ultima)+
      row2('Saldo pendiente', saldoStr)+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Documentos</div>'+
      filesHtml+
      (files.length ? '<button onclick="reanalizarDocs(\''+d['Folio']+'\',\''+nombre+'\')" id="btn_reanalizar_'+d['Folio']+'" '+
        'style="background:#0d7c66;color:#fff;border:none;border-radius:9px;padding:9px 16px;'+
        'font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;width:100%;display:flex;'+
        'align-items:center;justify-content:center;gap:8px;margin-top:10px">'+
        '<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none">'+
          '<polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>'+
        '</svg>'+
        'Analizar documentos con IA'+
      '</button>' : '')+
      '<div id="reanalizar_result_'+d['Folio']+'"></div>'+
    '</div>'+
    '<div class="dp-section" id="analysis_section_'+d['Folio']+'">'+
      '<div class="dp-section-title">Analisis crediticio por IA</div>'+
      (d['Dictamen'] && d['Dictamen']!=='' ?
        '<div style="background:#e8f5e9;border-radius:8px;padding:8px 12px;font-size:11px;color:#2e7d32;margin-bottom:8px">'+
        '&#10003; Dictamen guardado: <strong>'+d['Dictamen'].replace(/_/g,' ')+'</strong> &mdash; '+
        (d['Fecha analisis']||'').toString().substr(0,16)+'</div>' : '')+
      '<button onclick="runAnalysis(\''+d['Folio']+'\')" id="btn_analysis_'+d['Folio']+'" '+
        'style="background:var(--navy);color:#fff;border:none;border-radius:9px;padding:11px 18px;'+
        'font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;width:100%;display:flex;'+
        'align-items:center;justify-content:center;gap:8px;margin-bottom:8px">'+
        '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="1.8" fill="none">'+
          '<circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/>'+
        '</svg>'+
        'Generar dictamen crediticio completo'+
      '</button>'+
      '<div id="analysis_result_'+d['Folio']+'">'+
        (d['Resumen IA'] ? '<div style="background:var(--light);border-radius:8px;padding:12px 14px;font-size:13px;line-height:1.6;color:var(--text)">'+d['Resumen IA']+'</div>' : '')+
        (d['Siguiente paso'] ? '<div style="background:#e3f2fd;border-radius:8px;padding:10px 12px;border-left:3px solid var(--blue);margin-top:8px"><div style="font-size:10px;font-weight:700;color:var(--blue);text-transform:uppercase;margin-bottom:4px">Siguiente paso</div><div style="font-size:12px;color:var(--text)">'+d['Siguiente paso']+'</div></div>' : '')+
      '</div>'+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Cambiar estado</div>'+
      notasHtml+
      '<select id="dp_status" class="status-select">'+
        '<option value="">-- Selecciona estado --</option>'+
        '<option value="Pendiente">Pendiente</option>'+
        '<option value="En revision">En revision</option>'+
        '<option value="Docs incompletos">Docs incompletos</option>'+
        '<option value="Pre-aprobado">Pre-aprobado</option>'+
        '<option value="Aprobado">Aprobado</option>'+
        '<option value="Rechazado">Rechazado</option>'+
      '</select>'+
      '<textarea id="dp_nota" class="nota-input" placeholder="Nota interna (opcional)..."></textarea>'+
      '<button class="btn-save" onclick="saveStatus(\''+d['Folio']+'\')">Guardar cambio de estado</button>'+
      // â”€â”€ Mifiel: firma electrÃ³nica â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      (d['Dictamen']==='APROBAR'||d['Dictamen']==='APROBAR_CON_CONDICIONES' ? (
        '<div style="margin-top:20px;padding:16px;background:#f0f7ff;border:1px solid #c0d8ee;border-radius:10px">' +
        '<p style="font-weight:700;color:#1A3A4A;margin:0 0 12px;font-size:13px">âœï¸ Firma electrÃ³nica â€” Mifiel</p>' +
        '<div style="display:flex;gap:8px;flex-wrap:wrap" id="mifiel_btns_'+d['Folio']+'">' +
        buildMifielBtns_(d) +
        '</div>' +
        '<div id="mifiel_status_'+d['Folio']+'" style="margin-top:10px;font-size:12px;color:#555"></div>' +
        '</div>'
      ) : '') +
    '</div>';

  var sel=document.getElementById('dp_status');
  if(sel && d['Estado']){
    for(var i=0;i<sel.options.length;i++){
      if(sel.options[i].value===d['Estado']){sel.selectedIndex=i;break;}
    }
  }
}

function row2(l,v){
  if(v===null||v===undefined||v==='') return '';
  return '<div class="dp-row"><span>'+l+'</span><span>'+v+'</span></div>';
}

function saveStatus(folio){
  var status=document.getElementById('dp_status').value;
  var nota=document.getElementById('dp_nota').value;
  if(!status){alert('Selecciona un estado');return;}
  var btn=document.querySelector('.btn-save');
  if(btn){btn.disabled=true;btn.textContent='Guardando...';}
  callScript({action:'admin_status', pwd:userPwd, folio:folio, status:status, nota:nota}, function(d){
    if(d.ok){
      allRows.forEach(function(r){if(r['Folio']===folio)r['Estado']=status;});
      renderStats(); filterTable(); closeDetail();
    }else{
      alert('Error: '+(d.error||'desconocido'));
      if(btn){btn.disabled=false;btn.textContent='Guardar cambio de estado';}
    }
  });
}

function reanalizarDocs(folio, nombre){
  var btn = document.getElementById('btn_reanalizar_'+folio);
  var res = document.getElementById('reanalizar_result_'+folio);
  if(btn){ btn.disabled=true; }
  if(res){ res.innerHTML='<p style="font-size:12px;color:var(--muted);margin-top:8px">Obteniendo lista de documentos...</p>'; }

  // Step 1: Get file list (fast, no Claude)
  callScript({action:'admin_list_files', pwd:userPwd, folio:folio}, function(d){
    if(d.error){
      if(btn){ btn.disabled=false; btn.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Analizar documentos con IA'; }
      if(res) res.innerHTML='<p style="color:var(--red);font-size:12px;margin-top:6px">Error: '+d.error+'</p>';
      return;
    }
    var files = d.files || [];
    if(!files.length){
      if(btn){ btn.disabled=false; }
      if(res) res.innerHTML='<p style="color:var(--red);font-size:12px;margin-top:6px">No se encontraron archivos en Drive</p>';
      return;
    }
    // Step 2: Analyze each file individually
    procesarDocsUnoAUno(folio, files, d.nombre||nombre, d.mensualidad||0, 0, 0, btn, res);
  }, 15000);
}

function procesarDocsUnoAUno(folio, files, nombre, mensualidad, idx, ok, btn, res){
  if(idx >= files.length){
    // All done
    if(btn){ btn.disabled=false; btn.innerHTML='<svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg> Analizar documentos con IA'; }
    if(res) res.innerHTML='<p style="color:#0d7c66;font-size:12px;font-weight:700;margin-top:6px">'+ok+'/'+files.length+' documentos analizados. Generando dictamen...</p>';
    setTimeout(function(){ runAnalysis(folio); }, 600);
    return;
  }
  var f = files[idx];
  var pct = Math.round((idx/files.length)*100);
  if(res) res.innerHTML=
    '<div style="background:#e2e8f0;border-radius:6px;height:6px;margin:8px 0;overflow:hidden">'+
      '<div style="background:#0d7c66;height:6px;width:'+pct+'%;transition:width .3s"></div></div>'+
    '<p style="font-size:11px;color:var(--muted);margin:0">Analizando '+( idx+1)+'/'+files.length+': '+f.name.substr(0,40)+'...</p>';

  callScript({
    action:'admin_analizar_doc', pwd:userPwd, folio:folio,
    file_id:f.id, file_name:f.name, mime:f.mime,
    nombre:nombre, mensualidad:mensualidad
  }, function(d){
    var newOk = ok + (d.ok ? 1 : 0);
    // Continue with next doc after small delay
    setTimeout(function(){
      procesarDocsUnoAUno(folio, files, nombre, mensualidad, idx+1, newOk, btn, res);
    }, 2000);
  }, 30000);
}

function runAnalysis(folio){
  var btn = document.getElementById('btn_analysis_'+folio);
  var res = document.getElementById('analysis_result_'+folio);
  if(btn){ btn.disabled=true; btn.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="1.8" fill="none" style="animation:spin .8s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Analizando documentos con IA...'; }
  if(res){ res.innerHTML='<p style="font-size:12px;color:var(--muted);padding:8px 0">Esto puede tomar 15-30 segundos...</p>'; }
  callScript({action:'admin_analysis', pwd:userPwd, folio:folio}, function(d){
    if(btn){ btn.disabled=false; btn.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="1.8" fill="none"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg> Re-analizar'; }
    if(d.error){ if(res) res.innerHTML='<p style="color:var(--red);font-size:13px">'+d.error+'</p>'; return; }
    if(res) res.innerHTML = renderAnalysis(d.synthesis);
    // Reload detail to get updated score from sheet
    refreshScoreUI(folio);
  }, 120000);
}

function refreshScoreUI(folio){
  callScript({action:'admin_detail', pwd:userPwd, folio:folio}, function(d){
    if(d.error || !d.Score) return;
    // Update score in list row
    var rows = document.querySelectorAll('tr[data-folio="'+folio+'"], .sol-row[data-folio="'+folio+'"]');
    rows.forEach(function(r){
      var scoreEl = r.querySelector('.score-val, .score-bar-fill');
      if(scoreEl) scoreEl.textContent = d.Score;
    });
    // Update score in detail panel header
    var scoreEl = document.querySelector('.score-big .sn');
    var recEl   = document.querySelector('.score-big .rec');
    if(scoreEl){
      var s = Number(d.Score)||0;
      var color = s>=70?'var(--green)':s>=40?'var(--yellow)':'var(--red)';
      scoreEl.style.color = color;
      scoreEl.innerHTML   = s+'<span style="font-size:20px;color:var(--muted)">/100</span>';
    }
    if(recEl && d['RecomendaciÃ³n']) recEl.textContent = d['RecomendaciÃ³n'];
  }, 10000);
}

function renderAnalysis(s){
  if(!s) return '<p style="color:var(--muted);font-size:12px">Sin resultados</p>';
  var dictamenColors = {
    'APROBAR':'var(--green)', 'APROBAR_CON_CONDICIONES':'var(--yellow)',
    'SOLICITAR_MAS_INFORMACION':'var(--blue)', 'RECHAZAR':'var(--red)', 'ERROR':'var(--muted)'
  };
  var capColors = {
    'SUFICIENTE':'var(--green)','AJUSTADA':'var(--yellow)',
    'INSUFICIENTE':'var(--red)','NO_DETERMINADA':'var(--muted)'
  };
  var dc = dictamenColors[s.dictamen] || 'var(--muted)';
  var cap = s.capacidad_de_pago || {};
  var cc  = capColors[cap.nivel] || 'var(--muted)';
  var calidad = s.calidad_documentos || {};
  var html = '';

  // Dictamen badge
  html += '<div style="background:'+dc+';color:#fff;padding:10px 16px;border-radius:10px;font-weight:700;font-size:14px;text-align:center;margin-bottom:12px">'+
    (s.dictamen||'').replace(/_/g,' ')+'</div>';

  // Resumen
  if(s.resumen_ejecutivo){
    html += '<div style="background:var(--light);border-radius:8px;padding:12px 14px;font-size:13px;line-height:1.6;margin-bottom:12px;color:var(--text)">'+
      s.resumen_ejecutivo+'</div>';
  }

  // Capacidad de pago
  html += '<div style="border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:10px">';
  html += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px">Capacidad de pago</div>';
  html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">';
  html += '<span style="font-size:18px;font-weight:800;color:'+cc+'">'+(cap.nivel||'N/A')+'</span>';
  if(cap.porcentaje_compromiso) html += '<span style="font-size:12px;color:var(--muted)">'+cap.porcentaje_compromiso.toFixed(1)+'% del ingreso comprometido</span>';
  html += '</div>';
  if(cap.ingreso_promedio_estimado) html += '<div style="font-size:12px;color:var(--muted)">Ingreso prom. estimado: <strong style="color:var(--text)">$'+(Math.round(cap.ingreso_promedio_estimado)).toLocaleString('es-MX')+'</strong></div>';
  if(cap.comentario) html += '<div style="font-size:12px;color:var(--muted);margin-top:4px">'+cap.comentario+'</div>';
  html += '</div>';

  // Documentos
  html += '<div style="border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:10px">';
  html += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px">Calidad documental</div>';
  html += '<div style="display:flex;gap:12px;margin-bottom:6px">';
  if(calidad.documentos_ok!==undefined) html += '<span style="font-size:12px"><span style="color:var(--green);font-weight:700">'+calidad.documentos_ok+'</span> OK</span>';
  if(calidad.documentos_con_alerta) html += '<span style="font-size:12px"><span style="color:var(--yellow);font-weight:700">'+calidad.documentos_con_alerta+'</span> con alerta</span>';
  html += '</div>';
  if(calidad.comentario) html += '<div style="font-size:12px;color:var(--muted)">'+calidad.comentario+'</div>';
  html += '</div>';

  // Score desglose IA
  var desglose = s.score_desglose || {};
  if(s.score_ajustado){
    html += '<div style="border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:10px">';
    html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">';
    html += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px">Score IA</div>';
    html += '<div style="font-size:20px;font-weight:800;color:var(--navy)">'+s.score_ajustado+'<span style="font-size:12px;font-weight:400;color:var(--muted)">/100</span></div>';
    html += '</div>';
    var criterios = [
      {k:'historial_norlab', label:'Historial NORLAB', max:30, color:'#2A5870'},
      {k:'antiguedad',       label:'AntigÃ¼edad',       max:25, color:'#4AB8C8'},
      {k:'capacidad_pago',   label:'Capacidad de pago',max:25, color:'#2D7EA8'},
      {k:'documentacion',    label:'DocumentaciÃ³n',    max:20, color:'#6b9ab8'}
    ];
    criterios.forEach(function(c){
      var val = Number(desglose[c.k])||0;
      var pct = Math.round(val/c.max*100);
      html += '<div style="margin-bottom:6px">';
      html += '<div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px"><span style="color:var(--muted)">'+c.label+'</span><span style="font-weight:700;color:var(--navy)">'+val+'/'+c.max+'</span></div>';
      html += '<div style="background:#e8eef5;border-radius:4px;height:6px;overflow:hidden"><div style="width:'+pct+'%;height:100%;background:'+c.color+';border-radius:4px;transition:width .3s"></div></div>';
      html += '</div>';
    });
    html += '</div>';
  }

  // Factores
  var riesgos = s.factores_riesgo || [];
  var favor   = s.factores_favor  || [];
  if(riesgos.length||favor.length){
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">';
    if(favor.length){
      html += '<div style="background:#f1f8e9;border-radius:8px;padding:10px 12px">';
      html += '<div style="font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;margin-bottom:6px">A favor</div>';
      favor.forEach(function(f){ html += '<div style="font-size:11px;color:var(--text);margin-bottom:3px">+ '+f+'</div>'; });
      html += '</div>';
    }
    if(riesgos.length){
      html += '<div style="background:#ffebee;border-radius:8px;padding:10px 12px">';
      html += '<div style="font-size:10px;font-weight:700;color:var(--red);text-transform:uppercase;margin-bottom:6px">Riesgo</div>';
      riesgos.forEach(function(r){ html += '<div style="font-size:11px;color:var(--text);margin-bottom:3px">- '+r+'</div>'; });
      html += '</div>';
    }
    html += '</div>';
  }

  // Condiciones
  var condiciones = s.condiciones||[];
  if(condiciones.length){
    html += '<div style="background:#fff8e1;border-radius:8px;padding:10px 12px;margin-bottom:10px">';
    html += '<div style="font-size:10px;font-weight:700;color:var(--yellow);text-transform:uppercase;margin-bottom:6px">Condiciones para aprobar</div>';
    condiciones.forEach(function(c){ html += '<div style="font-size:12px;color:var(--text);margin-bottom:3px">â€¢ '+c+'</div>'; });
    html += '</div>';
  }

  // Siguiente paso
  if(s.siguiente_paso){
    html += '<div style="background:#e3f2fd;border-radius:8px;padding:10px 12px;border-left:3px solid var(--blue)">';
    html += '<div style="font-size:10px;font-weight:700;color:var(--blue);text-transform:uppercase;margin-bottom:4px">Siguiente paso</div>';
    html += '<div style="font-size:12px;color:var(--text)">'+s.siguiente_paso+'</div>';
    html += '</div>';
  }

  return html;
}

window.onload=function(){ document.getElementById('pwdInput').focus(); };

// â”€â”€ Mifiel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMifielBtns_(d) {
  var folio = d['Folio'];
  var btnStyle = 'border:none;border-radius:7px;padding:8px 14px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;';
  return '<button style="'+btnStyle+'background:#2D7EA8;color:#fff" onclick="signEnviar(\''+folio+'\',\'contrato\')">ğŸ“„ Generar Contrato</button>' +
    '<button style="'+btnStyle+'background:#4AB8C8;color:#fff" onclick="signEnviar(\''+folio+'\',\'pagare\')">ğŸ“‹ Generar PagarÃ©</button>' +
    '<button style="'+btnStyle+'background:#2A5870;color:#fff" onclick="signEnviar(\''+folio+'\',\'aviso\')">ğŸ”’ Aviso Privacidad</button>' +
    '<button style="'+btnStyle+'background:#f5f5f5;color:#2A5870;border:1px solid #c0d0dc" onclick="signVerEstado(\''+folio+'\')">â†» Ver estado</button>';
}

function signEnviar(folio, tipo) {
  var label = {contrato:'Contrato', pagare:'PagarÃ©', aviso:'Aviso de privacidad'}[tipo];
  var el = document.getElementById('mifiel_status_'+folio);
  if(el) el.innerHTML = '<span style="color:#2D7EA8">â³ Generando '+label+' y enviando a Zoho Sign...</span>';

  callScript({action:'sign_enviar', pwd:userPwd, folio:folio, tipo:tipo}, function(d){
    if(!el) return;
    if(d.ok){
      el.innerHTML =
        '<div style="background:#e8f5e9;border-radius:8px;padding:10px 12px;border-left:3px solid #4caf50">' +
        '<div style="font-weight:700;color:#2e7d32;margin-bottom:4px">âœ“ '+label+' enviado para firma</div>' +
        '<div style="font-size:11px;color:#555">'+d.mensaje+'</div>' +
        (d.sign_url ? '<a href="'+d.sign_url+'" target="_blank" style="display:inline-block;margin-top:8px;background:#2D7EA8;color:#fff;border-radius:6px;padding:5px 12px;font-size:11px;font-weight:600;text-decoration:none">ğŸ”— Link de firma del cliente</a>' : '') +
        '</div>';
    } else {
      el.innerHTML = '<div style="color:#c62828;font-size:12px;background:#ffebee;border-radius:6px;padding:8px 10px">âœ— Error: '+(d.error||'desconocido')+'</div>';
    }
  }, 30000);
}

function signVerEstado(folio) {
  var el = document.getElementById('mifiel_status_'+folio);
  if(el) el.innerHTML = '<span style="color:#2D7EA8;font-size:12px">â³ Consultando Zoho Sign...</span>';

  callScript({action:'sign_status_folio', pwd:userPwd, folio:folio}, function(d){
    if(!el) return;
    if(!d.ok || !d.contratos || d.contratos.length===0){
      el.innerHTML = '<span style="font-size:12px;color:#888">Sin documentos enviados a Zoho Sign aÃºn.</span>';
      return;
    }
    var html = '<div style="font-size:12px">';
    d.contratos.forEach(function(c){
      var color = c.firmado ? '#e8f5e9' : '#fff8e1';
      var icon  = c.firmado ? 'âœ“' : 'â³';
      var color2= c.firmado ? '#2e7d32' : '#f57c00';
      html += '<div style="background:'+color+';border-radius:6px;padding:6px 10px;margin-bottom:4px">' +
        '<span style="color:'+color2+';font-weight:700">'+icon+' '+c.tipo+'</span>' +
        ' Â· <span style="color:#555">'+c.estado+'</span>' +
        (c.pdf_url ? ' Â· <a href="'+c.pdf_url+'" target="_blank" style="color:#2D7EA8;font-weight:600">Descargar PDF firmado</a>' : '') +
        '</div>';
    });
    html += '</div>';
    el.innerHTML = html;
  }, 15000);
}

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  ['solicitudes','contratos','reactivos'].forEach(function(t) {
    var panel = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
    if(panel) panel.classList.toggle('active', t === tab);
    var btn = document.querySelector('[onclick="switchTab(\''+t+'\')"]');
    if(btn) btn.classList.toggle('active', t === tab);
  });
  if(tab === 'contratos') loadContratos();
  if(tab === 'reactivos') loadReactivos();
}

// â”€â”€ Contratos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NUEVAS FUNCIONES PARA GESTIÃ“N DE CONTRATOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var allContracts = [];

function loadContratos() {
  document.getElementById('contratosLoading').style.display = 'block';
  document.getElementById('contratosTable').style.display = 'none';
  document.getElementById('contratosEmpty').style.display = 'none';
  
  callScript({action:'admin_list_contratos', pwd:userPwd}, function(d) {
    document.getElementById('contratosLoading').style.display = 'none';
    
    if (d.ok && d.contratos && d.contratos.length > 0) {
      allContracts = d.contratos;
      renderContratos(allContracts);
      document.getElementById('contratosTable').style.display = 'block';
    } else {
      document.getElementById('contratosEmpty').style.display = 'block';
    }
  }, 15000);
}

function filtrarContratos() {
  var filtro = document.getElementById('filtroEstadoContrato').value;
  if (!filtro) {
    renderContratos(allContracts);
  } else {
    var filtrados = allContracts.filter(function(c) {
      var estado = c.estado_contrato || 'Pendiente GeneraciÃ³n';
      return estado === filtro;
    });
    renderContratos(filtrados);
  }
}

function generarContratos(folio) {
  if (!confirm('Â¿Generar contrato y pagarÃ©s para ' + folio + '?')) return;
  
  var btn = event.target;
  btn.disabled = true;
  btn.innerHTML = 'â³ Generando...';
  
  callScript({
    action: 'generar_contratos',
    pwd: userPwd,
    folio: folio
  }, function(d) {
    if (d.ok) {
      alert('Carpeta creada exitosamente');
      loadContratos();
    } else {
      alert('Error: ' + (d.error || 'No se pudo generar'));
      btn.disabled = false;
      btn.innerHTML = 'ğŸ“ Generar';
    }
  }, 30000);
}

function enviarZohoSign(folio) {
  if (!confirm('Â¿Enviar contrato a firma electrÃ³nica para ' + folio + '?')) return;
  
  var btn = event.target;
  btn.disabled = true;
  btn.innerHTML = 'â³ Enviando...';
  
  callScript({
    action: 'enviar_zoho_sign',
    pwd: userPwd,
    folio: folio
  }, function(d) {
    if (d.ok) {
      alert(d.mensaje || 'Enviado correctamente');
      loadContratos();
    } else {
      alert('Error: ' + (d.error || 'No se pudo enviar'));
      btn.disabled = false;
      btn.innerHTML = 'ğŸ“§ Enviar a Firma';
    }
  }, 30000);
}

function renderContratos(contratos) {
  var html = '<table>';
  html += '<thead><tr>';
  html += '<th>Folio</th>';
  html += '<th>Cliente</th>';
  html += '<th>Plan</th>';
  html += '<th>Estado Contrato</th>';
  html += '<th>Archivos</th>';
  html += '<th style="text-align:center;">Acciones</th>';
  html += '</tr></thead><tbody>';
  
  contratos.forEach(function(c) {
    html += '<tr style="border-bottom:1px solid var(--border);">';
    html += '<td><span style="font-weight:600;">' + c.folio + '</span></td>';
    html += '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;" title="' + c.nombre + '">' + c.nombre + '</td>';
    html += '<td><span class="badge badge-blue">' + c.plan + '</span></td>';
    
    var estado = c.estado_contrato || 'Pendiente GeneraciÃ³n';
    html += '<td>' + getEstadoBadge(estado) + '</td>';
    
    html += '<td>';
    if (c.carpeta_drive) {
      html += '<a href="https://drive.google.com/drive/folders/' + c.carpeta_drive + '" target="_blank" style="color:var(--blue);text-decoration:none;font-size:12px;">ğŸ“ Carpeta</a>';
    } else {
      html += '<span style="color:var(--muted);font-size:12px;">Sin archivos</span>';
    }
    html += '</td>';
    
    html += '<td style="text-align:center;">' + getBotonesAccion(c) + '</td>';
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  document.getElementById('contratosTable').innerHTML = html;
}

function getEstadoBadge(estado) {
  var badges = {
    'Pendiente GeneraciÃ³n': '<span class="badge badge-yellow">â³ Pendiente</span>',
    'Generado': '<span class="badge badge-blue">ğŸ“ Generado</span>',
    'Enviado a Firma': '<span class="badge" style="background:#f3e5f5;color:#7b1fa2;">ğŸ“§ Enviado</span>',
    'Firmado': '<span class="badge badge-green">âœ… Firmado</span>'
  };
  return badges[estado] || '<span class="badge badge-gray">' + estado + '</span>';
}

function getBotonesAccion(c) {
  var estado = c.estado_contrato || 'Pendiente GeneraciÃ³n';
  var html = '<div style="display:flex;gap:8px;justify-content:center;">';
  
  if (estado === 'Pendiente GeneraciÃ³n') {
    html += '<button onclick="generarContratos(\'' + c.folio + '\')" style="padding:6px 12px;background:var(--blue);color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">ğŸ“ Generar</button>';
  } else if (estado === 'Generado') {
    html += '<button onclick="enviarZohoSign(\'' + c.folio + '\')" style="padding:6px 12px;background:#7b1fa2;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">ğŸ“§ Enviar a Firma</button>';
  } else if (estado === 'Enviado a Firma') {
    html += '<button disabled style="padding:6px 12px;background:var(--muted);color:white;border:none;border-radius:6px;font-size:12px;opacity:0.6;">â³ Esperando...</button>';
  } else if (estado === 'Firmado') {
    html += '<button disabled style="padding:6px 12px;background:#2e7d32;color:white;border:none;border-radius:6px;font-size:12px;">âœ… Firmado</button>';
  }
  
  html += '</div>';
  return html;
}

function onFileSelect(folio) {
  var fileInput = document.getElementById('file_'+folio);
  var btn       = document.getElementById('btnUpload_'+folio);
  btn.disabled  = !fileInput.files.length;
}

function subirContrato(folio) {
  var fileInput = document.getElementById('file_'+folio);
  var msgEl     = document.getElementById('ctmsg_'+folio);
  if (!fileInput.files.length) return;
  var file = fileInput.files[0];
  var btn  = document.getElementById('btnUpload_'+folio);
  btn.disabled = true;
  btn.textContent = 'Subiendo...';
  msgEl.innerHTML = '<span class="ct-msg" style="color:var(--blue)">Subiendo archivo...</span>';

  var reader = new FileReader();
  reader.onload = function(e) {
    var b64 = e.target.result.split(',')[1];
    callScript({
      action: 'contratos_subir', pwd: userPwd,
      folio: folio, filename: file.name, base64: b64
    }, function(d) {
      btn.textContent = 'Subir revisado';
      if (d.ok) {
        msgEl.innerHTML = '<span class="ct-msg ct-msg-ok">Archivo subido. Ahora puedes enviarlo a Zoho Sign.</span>';
        document.getElementById('btnSign_'+folio).disabled = false;
        document.getElementById('btnSign_'+folio).removeAttribute('title');
      } else {
        btn.disabled = false;
        msgEl.innerHTML = '<span class="ct-msg ct-msg-err">Error: '+(d.error||'desconocido')+'</span>';
      }
    }, 30000);
  };
  reader.readAsDataURL(file);
}

function enviarASign(folio) {
  var btn   = document.getElementById('btnSign_'+folio);
  var msgEl = document.getElementById('ctmsg_'+folio);
  btn.disabled = true;
  btn.innerHTML = 'â³ Enviando a Zoho Sign...';
  msgEl.innerHTML = '';

  callScript({action:'contratos_a_sign', pwd:userPwd, folio:folio}, function(d) {
    if (d.ok) {
      btn.innerHTML = 'âœ“ Enviado â€” Ver en Zoho Sign';
      btn.onclick   = function(){ window.open('https://sign.zoho.com','_blank'); };
      btn.style.background = '#2e7d32';
      btn.disabled  = false;
      msgEl.innerHTML = '<span class="ct-msg ct-msg-ok">Draft creado en Zoho Sign (ID: '+d.request_id+'). Entra a Zoho Sign para revisar y enviar al cliente.</span>';
    } else {
      btn.disabled = false;
      btn.innerHTML = 'Enviar a Zoho Sign';
      msgEl.innerHTML = '<span class="ct-msg ct-msg-err">Error: '+(d.error||'desconocido')+'</span>';
    }
  }, 30000);
}

// â”€â”€ Reactivos catalog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadReactivos() {
  var area = document.getElementById('reactivosArea');
  area.innerHTML = '<div class="loading-spinner"><svg viewBox="0 0 24 24" width="18" height="18" stroke="#6b7c93" stroke-width="2" fill="none" style="animation:spin .8s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>&nbsp;Cargando cat\u00e1logo...</div>';
  callScript({action:'reactivos_lista', pwd:userPwd}, function(d) {
    if(!d.ok) { area.innerHTML='<div class="ct-msg ct-msg-err">Error: '+(d.error||'desconocido')+'</div>'; return; }
    renderReactivosTable(d.reactivos||[]);
  }, 15000);
}
function renderReactivosTable(list) {
  var area = document.getElementById('reactivosArea');
  if(!list.length){area.innerHTML='<div style="color:var(--muted);font-size:13px;padding:20px">Sin reactivos en el cat\u00e1logo. Haz clic en &ldquo;Agregar reactivo&rdquo; para comenzar.</div>';return;}
  var html='<table style="width:100%;border-collapse:collapse;font-size:13px">';
  html+='<thead><tr style="background:#e8eef5"><th style="padding:10px 12px;text-align:left;font-weight:700;color:var(--navy)">Reactivo</th><th style="padding:10px 12px;text-align:left;font-weight:700;color:var(--navy)">Marca/Modelo</th><th style="padding:10px 12px;text-align:right;font-weight:700;color:var(--navy)">Precio especial</th><th style="padding:10px 12px;text-align:left;font-weight:700;color:var(--navy)">Unidad</th><th style="padding:10px 12px;text-align:left;font-weight:700;color:var(--navy)">Equipos compatibles</th><th style="padding:10px 12px;text-align:center;font-weight:700;color:var(--navy)">Activo</th><th style="padding:10px 12px;text-align:center;font-weight:700;color:var(--navy)">Acciones</th></tr></thead><tbody>';
  list.forEach(function(r,i){
    var activo=r.activo!=='no';
    html+='<tr style="border-bottom:1px solid #e8eef5;opacity:'+(activo?'1':'.5')+'">';
    html+='<td style="padding:10px 12px;font-weight:600;color:var(--navy)">'+(r.n||'')+'</td>';
    html+='<td style="padding:10px 12px;color:var(--muted)">'+(r.m||'')+'</td>';
    html+='<td style="padding:10px 12px;text-align:right;font-weight:700;color:#2A5870">$'+(Number(r.p)||0).toLocaleString('es-MX',{minimumFractionDigits:2})+'</td>';
    html+='<td style="padding:10px 12px;color:var(--muted)">'+(r.u||'')+'</td>';
    html+='<td style="padding:10px 12px;color:var(--muted)">'+(r.e||'')+'</td>';
    html+='<td style="padding:10px 12px;text-align:center"><span style="display:inline-block;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700;'+(activo?'background:#e8f5e9;color:#2e7d32':'background:#f5f5f5;color:#999')+'">'+(activo?'Activo':'Inactivo')+'</span></td>';
    html+='<td style="padding:10px 12px;text-align:center;display:flex;gap:6px;justify-content:center">';
    html+='<button style="border:1px solid #d6eaf5;border-radius:6px;padding:5px 10px;font-size:11px;font-weight:600;cursor:pointer;background:#fff;color:var(--blue2);font-family:inherit" onclick="editReactivo('+i+')">Editar</button>';
    html+='<button style="border:none;border-radius:6px;padding:5px 10px;font-size:11px;font-weight:600;cursor:pointer;background:#feecea;color:#c62828;font-family:inherit" onclick="deleteReactivo(\''+encodeURIComponent(r.n||'')+'\')">Eliminar</button>';
    html+='</td></tr>';
  });
  html+='</tbody></table>';
  area.innerHTML=html;
  window._reactivosList=list;
}
var _editingReactivoIdx=null;
function showAddReactivoModal(){
  _editingReactivoIdx=null;
  document.getElementById('reactivoModalTitle').textContent='Agregar reactivo';
  ['rx_nombre','rx_marca','rx_precio','rx_unidad','rx_equipo'].forEach(function(id){document.getElementById(id).value='';});
  document.getElementById('rx_activo').value='si';
  document.getElementById('rx_modal_msg').style.display='none';
  document.getElementById('reactivoModal').style.display='flex';
}
function editReactivo(i){
  var r=(window._reactivosList||[])[i];
  if(!r)return;
  _editingReactivoIdx=i;
  document.getElementById('reactivoModalTitle').textContent='Editar reactivo';
  document.getElementById('rx_nombre').value=r.n||'';
  document.getElementById('rx_marca').value=r.m||'';
  document.getElementById('rx_precio').value=r.p||'';
  document.getElementById('rx_unidad').value=r.u||'';
  document.getElementById('rx_equipo').value=r.e||'';
  document.getElementById('rx_activo').value=r.activo||'si';
  document.getElementById('rx_modal_msg').style.display='none';
  document.getElementById('reactivoModal').style.display='flex';
}
function closeReactivoModal(){document.getElementById('reactivoModal').style.display='none';}
function saveReactivo(){
  var n=document.getElementById('rx_nombre').value.trim();
  var p=parseFloat(document.getElementById('rx_precio').value)||0;
  if(!n){document.getElementById('rx_modal_msg').textContent='El nombre es obligatorio.';document.getElementById('rx_modal_msg').style.display='block';return;}
  if(!p){document.getElementById('rx_modal_msg').textContent='El precio debe ser mayor a 0.';document.getElementById('rx_modal_msg').style.display='block';return;}
  var btn=document.getElementById('rx_save_btn');btn.disabled=true;btn.textContent='Guardando...';
  var payload={action:'reactivo_guardar',pwd:userPwd,
    n:n,m:document.getElementById('rx_marca').value.trim(),
    p:p,u:document.getElementById('rx_unidad').value.trim(),
    e:document.getElementById('rx_equipo').value.trim(),
    activo:document.getElementById('rx_activo').value,
    idx:_editingReactivoIdx
  };
  callScript(payload,function(d){
    btn.disabled=false;btn.textContent='Guardar';
    if(d.ok){closeReactivoModal();loadReactivos();}
    else{document.getElementById('rx_modal_msg').textContent='Error: '+(d.error||'desconocido');document.getElementById('rx_modal_msg').style.display='block';}
  },10000);
}
function deleteReactivo(nombre){
  if(!confirm('Â¿Eliminar "'+decodeURIComponent(nombre)+'" del catÃ¡logo?'))return;
  callScript({action:'reactivo_eliminar',pwd:userPwd,nombre:decodeURIComponent(nombre)},function(d){
    if(d.ok)loadReactivos();else alert('Error: '+(d.error||'desconocido'));
  },10000);
}

// â”€â”€ GUARDAR MONTOS EDITABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function guardarMonto(folio, campo) {
  var inputId = 'edit_' + campo.toLowerCase() + '_' + folio;
  var valor = parseFloat(document.getElementById(inputId).value) || 0;
  var msgEl = document.getElementById('msg_montos_' + folio);
  
  if (valor <= 0) {
    msgEl.textContent = 'âš  El monto debe ser mayor a 0';
    msgEl.style.color = '#c62828';
    msgEl.style.display = 'block';
    setTimeout(function(){ msgEl.style.display = 'none'; }, 3000);
    return;
  }
  
  msgEl.textContent = 'Guardando...';
  msgEl.style.color = 'var(--muted)';
  msgEl.style.display = 'block';
  
  callScript({
    action: 'actualizar_monto',
    pwd: userPwd,
    folio: folio,
    campo: campo,
    valor: valor
  }, function(d) {
    if (d.ok) {
      msgEl.textContent = 'âœ“ ' + campo + ' actualizado correctamente';
      msgEl.style.color = '#2e7d32';
      setTimeout(function(){ msgEl.style.display = 'none'; loadData(); }, 2000);
    } else {
      msgEl.textContent = 'âœ— Error: ' + (d.error || 'No se pudo guardar');
      msgEl.style.color = '#c62828';
      setTimeout(function(){ msgEl.style.display = 'none'; }, 4000);
    }
  }, 10000);
}

</script>
</body>
</html>