<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>NORLAB &mdash; Panel de Expedientes</title>
<style>
:root{
  --navy:#0b1f3a;--blue:#2D7EA8;--blue2:#2A5870;
  --light:#f7f9fc;--border:#e8edf5;--text:#0F2430;
  --muted:#6b7c93;--green:#2e7d32;--red:#c62828;--yellow:#b45309;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--light);color:var(--text);min-height:100vh;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
@keyframes spin{to{transform:rotate(360deg)}}
nav{background:var(--navy);padding:0 28px;height:62px;display:flex;align-items:center;justify-content:space-between;}
.nav-logo{height:38px;object-fit:contain;}
.nav-title{color:rgba(255,255,255,.5);font-size:13px;font-weight:600;letter-spacing:.5px;}
#loginScreen{display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 62px);padding:24px;}
.login-box{background:#fff;border-radius:20px;padding:40px;width:100%;max-width:380px;border:1px solid var(--border);box-shadow:0 8px 40px rgba(0,0,0,.08);animation:fadeUp .3s ease;}
.login-box h2{font-size:20px;font-weight:700;color:var(--navy);margin-bottom:6px;}
.login-box p{font-size:13px;color:var(--muted);margin-bottom:24px;}
.login-box input{width:100%;border:1.5px solid var(--border);border-radius:10px;padding:11px 14px;font-size:14px;font-family:inherit;outline:none;margin-bottom:12px;}
.login-box input:focus{border-color:var(--blue);}
.btn-login{width:100%;background:var(--blue);color:#fff;border:none;border-radius:10px;padding:13px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;}
.btn-login:hover:not(:disabled){background:var(--blue2);}
.btn-login:disabled{opacity:.6;cursor:not-allowed;}
#loginErr{color:var(--red);font-size:12px;margin-top:8px;min-height:16px;}
#mainScreen{display:none;animation:fadeUp .3s ease;}
.toolbar{background:#fff;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.toolbar-title{font-size:16px;font-weight:700;color:var(--navy);flex:1;}
.search-box{display:flex;align-items:center;gap:8px;background:var(--light);border:1.5px solid var(--border);border-radius:10px;padding:8px 12px;min-width:220px;}
.search-box input{border:none;background:none;font-size:13px;font-family:inherit;outline:none;width:100%;}
.filter-sel{border:1.5px solid var(--border);border-radius:10px;padding:8px 12px;font-size:13px;font-family:inherit;background:#fff;outline:none;color:var(--text);}
.btn-refresh{background:var(--blue);color:#fff;border:none;border-radius:10px;padding:9px 16px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px;}
.stats-bar{padding:16px 28px;display:flex;gap:12px;flex-wrap:wrap;}
.stat-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px 18px;min-width:120px;flex:1;}
.stat-n{font-size:28px;font-weight:800;color:var(--navy);line-height:1;}
.stat-l{font-size:11px;color:var(--muted);margin-top:4px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;}
.stat-card.green{border-color:#a5d6a7;background:#f1f8e9;} .stat-card.green .stat-n{color:var(--green);}
.stat-card.yellow{border-color:#ffe082;background:#fffde7;} .stat-card.yellow .stat-n{color:var(--yellow);}
.stat-card.red{border-color:#ef9a9a;background:#ffebee;} .stat-card.red .stat-n{color:var(--red);}
.stat-card.blue{border-color:#90caf9;background:#e3f2fd;} .stat-card.blue .stat-n{color:var(--blue);}
.table-wrap{padding:0 28px 28px;overflow-x:auto;}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden;border:1px solid var(--border);}
th{background:var(--navy);color:#fff;padding:11px 14px;font-size:11px;font-weight:700;text-align:left;letter-spacing:.5px;text-transform:uppercase;white-space:nowrap;}
td{padding:11px 14px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:#f8fafc;cursor:pointer;}
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap;}
.badge-green{background:#e8f5e9;color:var(--green);}
.badge-yellow{background:#fff8e1;color:var(--yellow);}
.badge-red{background:#ffebee;color:var(--red);}
.badge-blue{background:#e3f2fd;color:var(--blue);}
.badge-gray{background:#f5f5f5;color:#666;}
.score-bar{display:flex;align-items:center;gap:8px;}
.score-track{flex:1;height:6px;background:#e8edf5;border-radius:3px;min-width:60px;}
.score-fill{height:100%;border-radius:3px;}
#detailOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;}
#detailPanel{display:none;position:fixed;right:0;top:0;bottom:0;width:500px;max-width:95vw;background:#fff;box-shadow:-4px 0 32px rgba(0,0,0,.15);overflow-y:auto;z-index:201;}
.dp-head{background:var(--navy);padding:20px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
.dp-head h3{color:#fff;font-size:16px;font-weight:700;}
.dp-close{background:none;border:none;color:rgba(255,255,255,.7);cursor:pointer;font-size:24px;line-height:1;}
.dp-close:hover{color:#fff;}
.dp-body{padding:20px 24px;}
.dp-section{margin-bottom:20px;}
.dp-section-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.dp-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid #f5f7fa;}
.dp-row:last-child{border-bottom:none;}
.dp-row span:first-child{color:var(--muted);flex:0 0 140px;}
.dp-row span:last-child{font-weight:600;text-align:right;flex:1;}
.score-big{text-align:center;padding:20px;background:var(--light);border-radius:12px;margin-bottom:16px;}
.score-big .sn{font-size:48px;font-weight:900;line-height:1;}
.score-big .sl{font-size:13px;color:var(--muted);margin-top:6px;}
.score-big .rec{margin-top:10px;font-size:14px;font-weight:700;}
.status-select{border:1.5px solid var(--border);border-radius:9px;padding:9px 12px;font-size:13px;font-family:inherit;width:100%;margin-bottom:8px;background:#fff;}
.nota-input{border:1.5px solid var(--border);border-radius:9px;padding:9px 12px;font-size:13px;font-family:inherit;width:100%;min-height:72px;resize:vertical;margin-bottom:8px;}
.btn-save{background:var(--blue);color:#fff;border:none;border-radius:9px;padding:10px 20px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;width:100%;}
.file-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:12px;}
.file-item a{color:var(--blue);text-decoration:none;font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-drive{display:flex;align-items:center;gap:6px;background:#e3f2fd;color:var(--blue2);border:1px solid #90caf9;border-radius:8px;padding:8px 14px;font-size:12px;font-weight:700;text-decoration:none;margin-bottom:12px;}
.empty-state{text-align:center;padding:48px 20px;color:var(--muted);}
.loading-spinner{display:flex;align-items:center;justify-content:center;gap:10px;padding:48px;color:var(--muted);font-size:14px;}
.notes-log{background:var(--light);border-radius:8px;padding:10px 12px;font-size:12px;color:var(--muted);white-space:pre-wrap;line-height:1.6;max-height:100px;overflow-y:auto;margin-bottom:8px;}
</style>
</head>
<body>

<nav>
  <img class="nav-logo" src="https://raw.githubusercontent.com/RohmnosGrupo/financiamiento-norlab/main/norlab_logo_blanco_transp.png" alt="NORLAB" onerror="this.style.display='none'">
  <span class="nav-title">Panel de Expedientes</span>
</nav>

<div id="loginScreen">
  <div class="login-box">
    <h2>Acceso al panel</h2>
    <p>Ingresa la contrase&ntilde;a de administrador.</p>
    <input type="password" id="pwdInput" placeholder="Contrase&ntilde;a" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn-login" onclick="doLogin()">Ingresar</button>
    <div id="loginErr"></div>
  </div>
</div>

<div id="mainScreen">
  <div class="toolbar">
    <div class="toolbar-title">Solicitudes de Financiamiento</div>
    <div class="search-box">
      <svg viewBox="0 0 24 24" width="15" height="15" stroke="#6b7c93" stroke-width="2" fill="none"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="searchInput" placeholder="Buscar nombre, folio, equipo..." oninput="filterTable()">
    </div>
    <select class="filter-sel" id="filterEstado" onchange="filterTable()">
      <option value="">Todos los estados</option>
      <option>Pendiente</option>
      <option>En revision</option>
      <option>Docs incompletos</option>
      <option>Pre-aprobado</option>
      <option>Aprobado</option>
      <option>Rechazado</option>
    </select>
    <select class="filter-sel" id="filterPlan" onchange="filterTable()">
      <option value="">Todos los planes</option>
      <option>Financiamiento</option>
      <option>Renta mensual</option>
      <option>Comodato</option>
    </select>
    <button class="btn-refresh" onclick="loadData()">
      <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2.5" fill="none"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
      Actualizar
    </button>
  </div>
  <div class="stats-bar" id="statsBar"></div>
  <div class="table-wrap">
    <div id="tableArea"><div class="loading-spinner">Esperando...</div></div>
  </div>
</div>

<div id="detailOverlay" onclick="closeDetail()"></div>
<div id="detailPanel">
  <div class="dp-head">
    <h3 id="dp-title">Detalle</h3>
    <button class="dp-close" onclick="closeDetail()">&times;</button>
  </div>
  <div class="dp-body" id="dp-body"></div>
</div>

<script>
var SCRIPT = 'https://script.google.com/macros/s/AKfycbxssE_vKrhv2NB-07gBddfFaA01-ORPxGXrap_it2Gvs2uD8jhywHFVzTSOlnV-cZFL/exec';
var allRows = [], userPwd = '';

// ── Auth ──────────────────────────────────────────────────────────────────────
function doLogin(){
  var pwd = document.getElementById('pwdInput').value.trim();
  if(!pwd) return;
  var btn = document.querySelector('.btn-login');
  var err = document.getElementById('loginErr');
  err.style.display='none';
  btn.disabled=true; btn.textContent='Verificando...';

  callScript({action:'admin_list', pwd:pwd}, function(data){
    btn.disabled=false; btn.textContent='Ingresar';
    if(data.error==='No autorizado'){
      err.textContent = 'Contrasena incorrecta';
      err.style.display='block';
      return;
    }
    if(data.error){
      err.textContent = 'Error: '+data.error;
      err.style.display='block';
      return;
    }
    userPwd = pwd;
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('mainScreen').style.display='block';
    allRows = data.rows||[];
    renderStats();
    renderTable(allRows);
  });
}

// ── Data ──────────────────────────────────────────────────────────────────────
function loadData(){
  document.getElementById('tableArea').innerHTML='<div class="loading-spinner"><svg viewBox="0 0 24 24" width="20" height="20" stroke="#2A5870" stroke-width="2" fill="none" style="animation:spin .8s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Actualizando...</div>';
  callScript({action:'admin_list', pwd:userPwd}, function(data){
    allRows = data.rows||[];
    renderStats();
    filterTable();
  });
}

function callScript(params, cb, timeout){
  var cb_name='_cb'+Date.now();
  var sc=document.createElement('script');
  var to=setTimeout(function(){cleanup();cb({error:'Timeout - sin respuesta del servidor'});}, timeout||10000);
  window[cb_name]=function(d){clearTimeout(to);cleanup();cb(d);};
  var qs=Object.keys(params).map(function(k){
    return encodeURIComponent(k)+'='+encodeURIComponent(params[k]);
  }).join('&');
  sc.src=SCRIPT+'?'+qs+'&callback='+cb_name+'&ts='+Date.now();
  sc.onerror=function(){clearTimeout(to);cleanup();cb({error:'Error de conexion'});};
  document.head.appendChild(sc);
  function cleanup(){if(document.head.contains(sc))document.head.removeChild(sc);delete window[cb_name];}
}

// ── Stats ─────────────────────────────────────────────────────────────────────
function renderStats(){
  var total=allRows.length;
  var pendiente=allRows.filter(function(r){return (r['Estado']||'Pendiente')==='Pendiente';}).length;
  var aprobado=allRows.filter(function(r){return r['Estado']==='Aprobado'||r['Estado']==='Pre-aprobado';}).length;
  var revision=allRows.filter(function(r){return r['Estado']==='En revision';}).length;
  var rechazado=allRows.filter(function(r){return r['Estado']==='Rechazado';}).length;
  var avgScore=total>0?Math.round(allRows.reduce(function(s,r){return s+(Number(r['Score'])||0);},0)/total):0;

  document.getElementById('statsBar').innerHTML=
    stat(total,'Total solicitudes','blue')+
    stat(pendiente,'Pendientes','yellow')+
    stat(revision,'En revision','blue')+
    stat(aprobado,'Pre-aprobados / Aprobados','green')+
    stat(rechazado,'Rechazados','red')+
    stat(avgScore,'Score promedio','blue');
}
function stat(n,l,cls){
  return '<div class="stat-card '+cls+'"><div class="stat-n">'+n+'</div><div class="stat-l">'+l+'</div></div>';
}

// ── Table ─────────────────────────────────────────────────────────────────────
function filterTable(){
  var q=(document.getElementById('searchInput').value||'').toLowerCase();
  var est=document.getElementById('filterEstado').value;
  var plan=document.getElementById('filterPlan').value;
  var filtered=allRows.filter(function(r){
    var nombre=r['Nombre / Razon Social']||r['Nombre / Razón Social']||'';
    var matchQ=!q||
      (r['Folio']||'').toLowerCase().indexOf(q)>-1||
      nombre.toLowerCase().indexOf(q)>-1||
      (r['Equipo']||'').toLowerCase().indexOf(q)>-1||
      (r['Email']||'').toLowerCase().indexOf(q)>-1;
    var matchE=!est||(r['Estado']||'Pendiente')===est;
    var matchP=!plan||(r['Plan']||'')===plan;
    return matchQ&&matchE&&matchP;
  });
  renderTable(filtered);
}

function renderTable(rows){
  if(!rows.length){
    document.getElementById('tableArea').innerHTML='<div class="empty-state">'+
      '<svg viewBox="0 0 24 24" width="48" height="48" stroke="#ccc" stroke-width="1.5" fill="none"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/></svg>'+
      '<br>No hay solicitudes que coincidan</div>';
    return;
  }
  var html='<table><thead><tr>'+
    '<th>Folio</th><th>Fecha</th><th>Cliente</th><th>Equipo</th><th>Plan</th>'+
    '<th>Score</th><th>Estado</th><th>Docs</th><th>Ciudad</th>'+
    '</tr></thead><tbody>';

  rows.forEach(function(r){
    var folio=r['Folio']||'';
    var fecha=String(r['Fecha']||'').substr(0,10);
    var nombre=r['Nombre / Razon Social']||r['Nombre / Razón Social']||'';
    var equipo=r['Equipo']||'';
    var plan=r['Plan']||'';
    var score=Number(r['Score'])||0;
    var estado=r['Estado']||'Pendiente';
    var docsOk=Number(r['Docs OK'])||0;
    var docsReq=Number(r['Docs Req'])||4;
    var ciudad=r['Ciudad']||'';
    var email=r['Email']||'';
    var scoreCls=score>=70?'#2e7d32':score>=40?'#b45309':'#c62828';
    var estadoBadge=badgeEstado(estado);
    var docsBadge=docsOk>=docsReq?
      '<span class="badge badge-green">'+docsOk+'/'+docsReq+'</span>':
      '<span class="badge badge-yellow">'+docsOk+'/'+docsReq+'</span>';

    html+='<tr onclick="openDetail(\''+folio+'\')">'+
      '<td><strong style="color:var(--navy)">'+folio+'</strong></td>'+
      '<td style="color:var(--muted)">'+fecha+'</td>'+
      '<td><div style="font-weight:600">'+nombre+'</div><div style="font-size:11px;color:var(--muted)">'+email+'</div></td>'+
      '<td>'+equipo+'</td>'+
      '<td><span style="font-size:12px">'+plan+'</span></td>'+
      '<td><div class="score-bar"><strong style="color:'+scoreCls+';font-size:15px;min-width:28px">'+score+'</strong>'+
        '<div class="score-track"><div class="score-fill" style="width:'+Math.min(score,100)+'%;background:'+scoreCls+'"></div></div></div></td>'+
      '<td>'+estadoBadge+'</td>'+
      '<td>'+docsBadge+'</td>'+
      '<td style="color:var(--muted);font-size:12px">'+ciudad+'</td>'+
      '</tr>';
  });
  html+='</tbody></table>';
  document.getElementById('tableArea').innerHTML=html;
}

function badgeEstado(e){
  var map={
    'Pendiente':'badge-yellow','En revision':'badge-blue','En revisión':'badge-blue',
    'Docs incompletos':'badge-yellow','Pre-aprobado':'badge-green',
    'Aprobado':'badge-green','Rechazado':'badge-red'
  };
  return '<span class="badge '+(map[e]||'badge-gray')+'">'+e+'</span>';
}

// ── Detail ────────────────────────────────────────────────────────────────────
function openDetail(folio){
  document.getElementById('detailOverlay').style.display='block';
  document.getElementById('detailPanel').style.display='block';
  document.getElementById('dp-title').textContent=folio;
  document.getElementById('dp-body').innerHTML='<div class="loading-spinner"><svg viewBox="0 0 24 24" width="20" height="20" stroke="#2A5870" stroke-width="2" fill="none" style="animation:spin .8s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Cargando detalle...</div>';
  callScript({action:'admin_detail', pwd:userPwd, folio:folio}, function(d){
    if(d.error){document.getElementById('dp-body').innerHTML='<p style="color:red;padding:20px">'+d.error+'</p>';return;}
    renderDetail(d);
  });
}
function closeDetail(){
  document.getElementById('detailOverlay').style.display='none';
  document.getElementById('detailPanel').style.display='none';
}

function renderDetail(d){
  var score=Number(d['Score'])||0;
  var rec=(d['Recomendacion']||d['Recomendación']||'').replace(/[\u2705\u{1F7E1}\u{1F534}]/gu,'').trim();
  var scoreCls=score>=70?'var(--green)':score>=40?'var(--yellow)':'var(--red)';
  var recIcon=score>=70?'Pre-aprobado':score>=40?'Revisar':'No procede';

  var filesHtml='';
  if(d._drive_url){
    filesHtml+='<a class="btn-drive" href="'+d._drive_url+'" target="_blank">'+
      '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="1.8" fill="none"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>'+
      'Abrir carpeta en Drive</a>';
  }
  var files=d._files||[];
  if(files.length){
    files.forEach(function(f){
      filesHtml+='<div class="file-item">'+
        '<svg viewBox="0 0 24 24" width="16" height="16" stroke="#2A5870" stroke-width="1.8" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>'+
        '<a href="'+f.url+'" target="_blank">'+f.name+'</a>'+
        '</div>';
    });
  }else{
    filesHtml+='<p style="font-size:12px;color:var(--muted)">Sin documentos subidos.</p>';
  }

  var notas=d['Notas']||'';
  var notasHtml=notas?'<div class="notes-log">'+notas+'</div>':'';

  var nombre=d['Nombre / Razon Social']||d['Nombre / Razón Social']||'';
  var tel=d['Telefono']||d['Teléfono']||'';
  var anos=d['Anos operacion']||d['Años operación']||'';
  var ultima=d['Zoho: Ultima compra']||d['Zoho: Última compra']||'-';
  var saldo=d['Zoho: Saldo pendiente'];

  document.getElementById('dp-body').innerHTML=
    '<div class="score-big">'+
      '<div class="sn" style="color:'+scoreCls+'">'+score+'<span style="font-size:20px;color:var(--muted)">/100</span></div>'+
      '<div class="sl">Score de evaluacion automatica</div>'+
      '<div class="rec" style="color:'+scoreCls+'">'+recIcon+'</div>'+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Plan solicitado</div>'+
      row2('Equipo',d['Equipo'])+row2('Plan',d['Plan'])+row2('Plazo',d['Plazo']?d['Plazo']+' meses':'')+row2('Mensualidad',d['Mensualidad'])+row2('Enganche',d['Enganche'])+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Solicitante</div>'+
      row2('Nombre',nombre)+row2('Tipo',d['Tipo'])+row2('RFC',d['RFC'])+row2('Telefono',tel)+row2('Email',d['Email'])+row2('Ciudad',d['Ciudad'])+row2('Negocio',d['Negocio / Empresa'])+row2('Antiguedad',anos)+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Historial Zoho</div>'+
      row2('Cliente',d['Zoho: Cliente'])+
      row2('Total compras',d['Zoho: Total compras']?'$'+Number(d['Zoho: Total compras']).toLocaleString('es-MX'):'')+
      row2('Facturas pagadas',d['Zoho: Facturas pagadas'])+
      row2('Ultima compra',ultima)+
      row2('Saldo pendiente',saldo>0?'$'+Number(saldo).toLocaleString('es-MX'):'$0')+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Documentos</div>'+
      filesHtml+
    '</div>'+
    '<div class="dp-section" id="analysis_section_'+d['Folio']+'">'+
      '<div class="dp-section-title">Analisis crediticio por IA</div>'+
      '<button onclick="runAnalysis(\''+d['Folio']+'\')" id="btn_analysis_'+d['Folio']+'" '+
        'style="background:var(--navy);color:#fff;border:none;border-radius:9px;padding:11px 18px;'+
        'font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;width:100%;display:flex;'+
        'align-items:center;justify-content:center;gap:8px;margin-bottom:8px">'+
        '<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="1.8" fill="none">'+
          '<circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/>'+
        '</svg>'+
        'Generar dictamen crediticio completo'+
      '</button>'+
      '<div id="analysis_result_'+d['Folio']+'"></div>'+
    '</div>'+
    '<div class="dp-section">'+
      '<div class="dp-section-title">Cambiar estado</div>'+
      notasHtml+
      '<select id="dp_status" class="status-select">'+
        '<option value="">-- Selecciona estado --</option>'+
        '<option value="Pendiente">Pendiente</option>'+
        '<option value="En revision">En revision</option>'+
        '<option value="Docs incompletos">Docs incompletos</option>'+
        '<option value="Pre-aprobado">Pre-aprobado</option>'+
        '<option value="Aprobado">Aprobado</option>'+
        '<option value="Rechazado">Rechazado</option>'+
      '</select>'+
      '<textarea id="dp_nota" class="nota-input" placeholder="Nota interna (opcional)..."></textarea>'+
      '<button class="btn-save" onclick="saveStatus(\''+d['Folio']+'\')">Guardar cambio de estado</button>'+
    '</div>';

  var sel=document.getElementById('dp_status');
  if(sel && d['Estado']){
    for(var i=0;i<sel.options.length;i++){
      if(sel.options[i].value===d['Estado']){sel.selectedIndex=i;break;}
    }
  }
}

function row2(l,v){
  if(v===null||v===undefined||v==='') return '';
  return '<div class="dp-row"><span>'+l+'</span><span>'+v+'</span></div>';
}

function saveStatus(folio){
  var status=document.getElementById('dp_status').value;
  var nota=document.getElementById('dp_nota').value;
  if(!status){alert('Selecciona un estado');return;}
  var btn=document.querySelector('.btn-save');
  if(btn){btn.disabled=true;btn.textContent='Guardando...';}
  callScript({action:'admin_status', pwd:userPwd, folio:folio, status:status, nota:nota}, function(d){
    if(d.ok){
      allRows.forEach(function(r){if(r['Folio']===folio)r['Estado']=status;});
      renderStats(); filterTable(); closeDetail();
    }else{
      alert('Error: '+(d.error||'desconocido'));
      if(btn){btn.disabled=false;btn.textContent='Guardar cambio de estado';}
    }
  });
}

function runAnalysis(folio){
  var btn = document.getElementById('btn_analysis_'+folio);
  var res = document.getElementById('analysis_result_'+folio);
  if(btn){ btn.disabled=true; btn.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="1.8" fill="none" style="animation:spin .8s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Analizando documentos con IA...'; }
  if(res){ res.innerHTML='<p style="font-size:12px;color:var(--muted);padding:8px 0">Esto puede tomar 15-30 segundos...</p>'; }
  callScript({action:'admin_analysis', pwd:userPwd, folio:folio}, function(d){
    if(btn){ btn.disabled=false; btn.innerHTML='<svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="1.8" fill="none"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg> Re-analizar'; }
    if(d.error){ if(res) res.innerHTML='<p style="color:var(--red);font-size:13px">'+d.error+'</p>'; return; }
    if(res) res.innerHTML = renderAnalysis(d.synthesis);
  }, 45000);
}

function renderAnalysis(s){
  if(!s) return '<p style="color:var(--muted);font-size:12px">Sin resultados</p>';
  var dictamenColors = {
    'APROBAR':'var(--green)', 'APROBAR_CON_CONDICIONES':'var(--yellow)',
    'SOLICITAR_MAS_INFORMACION':'var(--blue)', 'RECHAZAR':'var(--red)', 'ERROR':'var(--muted)'
  };
  var capColors = {
    'SUFICIENTE':'var(--green)','AJUSTADA':'var(--yellow)',
    'INSUFICIENTE':'var(--red)','NO_DETERMINADA':'var(--muted)'
  };
  var dc = dictamenColors[s.dictamen] || 'var(--muted)';
  var cap = s.capacidad_de_pago || {};
  var cc  = capColors[cap.nivel] || 'var(--muted)';
  var calidad = s.calidad_documentos || {};
  var html = '';

  // Dictamen badge
  html += '<div style="background:'+dc+';color:#fff;padding:10px 16px;border-radius:10px;font-weight:700;font-size:14px;text-align:center;margin-bottom:12px">'+
    (s.dictamen||'').replace(/_/g,' ')+'</div>';

  // Resumen
  if(s.resumen_ejecutivo){
    html += '<div style="background:var(--light);border-radius:8px;padding:12px 14px;font-size:13px;line-height:1.6;margin-bottom:12px;color:var(--text)">'+
      s.resumen_ejecutivo+'</div>';
  }

  // Capacidad de pago
  html += '<div style="border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:10px">';
  html += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px">Capacidad de pago</div>';
  html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">';
  html += '<span style="font-size:18px;font-weight:800;color:'+cc+'">'+(cap.nivel||'N/A')+'</span>';
  if(cap.porcentaje_compromiso) html += '<span style="font-size:12px;color:var(--muted)">'+cap.porcentaje_compromiso.toFixed(1)+'% del ingreso comprometido</span>';
  html += '</div>';
  if(cap.ingreso_promedio_estimado) html += '<div style="font-size:12px;color:var(--muted)">Ingreso prom. estimado: <strong style="color:var(--text)">$'+(Math.round(cap.ingreso_promedio_estimado)).toLocaleString('es-MX')+'</strong></div>';
  if(cap.comentario) html += '<div style="font-size:12px;color:var(--muted);margin-top:4px">'+cap.comentario+'</div>';
  html += '</div>';

  // Documentos
  html += '<div style="border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:10px">';
  html += '<div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px">Calidad documental</div>';
  html += '<div style="display:flex;gap:12px;margin-bottom:6px">';
  if(calidad.documentos_ok!==undefined) html += '<span style="font-size:12px"><span style="color:var(--green);font-weight:700">'+calidad.documentos_ok+'</span> OK</span>';
  if(calidad.documentos_con_alerta) html += '<span style="font-size:12px"><span style="color:var(--yellow);font-weight:700">'+calidad.documentos_con_alerta+'</span> con alerta</span>';
  html += '</div>';
  if(calidad.comentario) html += '<div style="font-size:12px;color:var(--muted)">'+calidad.comentario+'</div>';
  html += '</div>';

  // Factores
  var riesgos = s.factores_riesgo || [];
  var favor   = s.factores_favor  || [];
  if(riesgos.length||favor.length){
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">';
    if(favor.length){
      html += '<div style="background:#f1f8e9;border-radius:8px;padding:10px 12px">';
      html += '<div style="font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;margin-bottom:6px">A favor</div>';
      favor.forEach(function(f){ html += '<div style="font-size:11px;color:var(--text);margin-bottom:3px">+ '+f+'</div>'; });
      html += '</div>';
    }
    if(riesgos.length){
      html += '<div style="background:#ffebee;border-radius:8px;padding:10px 12px">';
      html += '<div style="font-size:10px;font-weight:700;color:var(--red);text-transform:uppercase;margin-bottom:6px">Riesgo</div>';
      riesgos.forEach(function(r){ html += '<div style="font-size:11px;color:var(--text);margin-bottom:3px">- '+r+'</div>'; });
      html += '</div>';
    }
    html += '</div>';
  }

  // Condiciones
  var condiciones = s.condiciones||[];
  if(condiciones.length){
    html += '<div style="background:#fff8e1;border-radius:8px;padding:10px 12px;margin-bottom:10px">';
    html += '<div style="font-size:10px;font-weight:700;color:var(--yellow);text-transform:uppercase;margin-bottom:6px">Condiciones para aprobar</div>';
    condiciones.forEach(function(c){ html += '<div style="font-size:12px;color:var(--text);margin-bottom:3px">• '+c+'</div>'; });
    html += '</div>';
  }

  // Siguiente paso
  if(s.siguiente_paso){
    html += '<div style="background:#e3f2fd;border-radius:8px;padding:10px 12px;border-left:3px solid var(--blue)">';
    html += '<div style="font-size:10px;font-weight:700;color:var(--blue);text-transform:uppercase;margin-bottom:4px">Siguiente paso</div>';
    html += '<div style="font-size:12px;color:var(--text)">'+s.siguiente_paso+'</div>';
    html += '</div>';
  }

  return html;
}

window.onload=function(){ document.getElementById('pwdInput').focus(); };

</script>
</body>
</html>